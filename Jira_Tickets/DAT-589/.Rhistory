mutate(total=nrow(cny_totals))%>%
filter(Value!="Unknown"&Value!="Other Miscellaneous Titles")%>%
top_n(10,n)%>%
ggplot(aes(reorder(Value,n),n,label=n))+geom_bar(stat="identity",position="dodge",fill="pink")+coord_flip()+geom_text(position="dodge",hjust=-0.1,size=2.5)+theme_minimal()+xlab("Business Industry")+ylab("Count of Active Customers")+labs(title="Top 10 CNY Health Pulse Job Titles")
knitr::kable(pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(Value=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
separate(Value,into=c("Value","Value_2"),sep="-")%>%
select(Value,n)%>%
mutate(total=cny_totals)%>%
mutate(`Job Title`=Value,
`Active Customers`=n,
`Total Subscribers`=total)%>%
select(`Job Title`,`Active Customers`,`Total Subscribers`)%>%
top_n(10,`Active Customers`)%>%
mutate(`Share of Total Customers`=(round(`Active Customers`/`Total Subscribers`*100,2))))
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))
cny_top_business<-(pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(Value=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Other",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
filter(Value!="Other")%>%
top_n(5,n))$Value
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)%>%
slice(1:5)
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)%>%
slice(1:5)%>%
mutate(share=round(n/total,3)*100)
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)%>%
slice(1:5)%>%
mutate(share=round(n/total,3)*100)%>%
ggplot(aes(reorder(business,total),n,fill=job,label=n))+geom_bar(stat="identity",position="dodge")+theme_minimal()+coord_flip()+geom_text(position=position_dodge(width=0.9),hjust=-0.2,size=2.5)+xlab("Business Industry")+ylab("Count of Customers")+labs("Count of Jobs Across Industry Excluding Unidentified Businesses and Jobs")
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)%>%
slice(1:5)%>%
mutate(share=round(n/total,3)*100)%>%
ggplot(aes(reorder(business,total),n,fill=job,label=n))+geom_bar(stat="identity",position="dodge")+theme_minimal()+coord_flip()+geom_text(position=position_dodge(width=0.9),hjust=-0.2,size=2.5)+xlab("Business Industry")+ylab("Share of Job Titles")+labs("Count of Jobs Across Industry Excluding Unidentified Businesses and Jobs")
pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(job=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(business=Value.y)%>%
mutate(job=ifelse(is.na(job)|str_detect(job,"Others Allied"),"Unknown",job))%>%
mutate(business=ifelse(is.na(business)|str_detect(business,"Others Allied"),"Other",business))%>%
separate(job,into=c("job","job_2"),sep="-")%>%
filter(job!="Unknown")%>%
group_by(business,job)%>%
summarise(n=n_distinct(customeraccountid))%>%
mutate(total=sum(n))%>%
filter(business%in%cny_top_business)%>%
slice(1:5)%>%
mutate(share=round(n/total,3)*100)%>%
mutate(`Job Title`=job)%>%
ggplot(aes(reorder(business,total),n,fill=job,label=n))+geom_bar(stat="identity",position="dodge")+theme_minimal()+coord_flip()+geom_text(position=position_dodge(width=0.9),hjust=-0.2,size=2.5)+xlab("Business Industry")+ylab("Share of Job Titles")+labs(title="Share of Jobs Across Industry Excluding Unidentified Businesses and Jobs")
cny_job_percent<-pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
left_join(cny_j,by=c("metadatacrainjobfunction"="Code"))%>%
mutate(Value=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Unknown",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
separate(Value,into=c("Value","Value_2"),sep="-")%>%
select(Value,n)%>%
mutate(total=nrow(cny_totals))%>%
filter(Value!="Unknown"&Value!="Other Miscellaneous Titles")%>%
top_n(5,n)%>%
mutate(Brand="CNY Health Pulse")%>%
mutate(`Job Title`=Value)%>%
mutate(`Active Customers`=n)%>%
mutate(`Total Customers`=cny_totals-cny_j_other)%>%
select(-c(Value,n))%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
ccb_job_percent<-pelcro_table%>%
select(customeraccountid,businessunitcode)%>%
filter(businessunitcode=="CCB")%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
select(customeraccountid,metadatacrainjobfunction)%>%
distinct()%>%
group_by(customeraccountid)%>%
left_join(ccb_j,by=c("jobid"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Misc titles including Government",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(`Total Customers`=ccb_totals-ccb_j_other)%>%
top_n(10,n)%>%
mutate(Brand="CCB")%>%
mutate(`Job Title`=Value,
`Active Customers`=n)%>%
select(-c(Value,n))%>%
select(Brand,`Job Title`,`Active Customers`,`Total Customers`)%>%
filter(!str_detect(`Job Title`,"Misc titles including"))%>%
top_n(5,`Active Customers`)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
ccb_job_percent<-pelcro_table%>%
select(customeraccountid,businessunitcode)%>%
filter(businessunitcode=="CCB")%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
select(customeraccountid,metadatacrainjobfunction)%>%
distinct()%>%
group_by(customeraccountid)%>%
left_join(ccb_j,by=c("metadatacrainjobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Misc titles including Government",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(`Total Customers`=ccb_totals-ccb_j_other)%>%
top_n(10,n)%>%
mutate(Brand="CCB")%>%
mutate(`Job Title`=Value,
`Active Customers`=n)%>%
select(-c(Value,n))%>%
select(Brand,`Job Title`,`Active Customers`,`Total Customers`)%>%
filter(!str_detect(`Job Title`,"Misc titles including"))%>%
top_n(5,`Active Customers`)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
MH_job_percent<-adv_data%>%
filter(publicationcode=="MH")%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=today())%>%
filter(circulationstatus%in%c("R"))%>%
select(shiptocustomernumber)%>%
distinct()%>%
left_join(index,by=c("shiptocustomernumber"="advantagecustomerid"))%>%
mutate(clickshareuserid=as.numeric(clickshareuserid))%>%
group_by(shiptocustomernumber)%>%
left_join(business_job_adv,by=c("clickshareuserid"="clickshareuserid"))%>%
mutate(jobfunction=as.numeric(jobfunction))%>%
mutate(jobfunction=ifelse(is.na(jobfunction),99,jobfunction))%>%
left_join(mh_j,by=c("jobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"unknown",Value))%>%
group_by(shiptocustomernumber)%>%
mutate(min_job=min(jobfunction))%>%
filter(jobfunction==min_job)%>%
ungroup()%>%
select(shiptocustomernumber,Value)%>%
distinct()%>%
group_by(Value)%>%
summarise(`Active Customers`=n_distinct(shiptocustomernumber))%>%
arrange(desc(`Active Customers`))%>%
ungroup()%>%
mutate(`Job Title`=Value)%>%
select(-Value)%>%
mutate(`Total Subscribers`=sum(`Active Customers`))%>%
top_n(10,`Active Customers`)%>%
mutate(Brand="MH")%>%
select(Brand,`Job Title`,`Active Customers`)%>%
filter(!str_detect(`Job Title`,'Other hospital/healthcare executives not listed above'))%>%
top_n(5,`Active Customers`)%>%
mutate(`Total Customers`=mh_totals-mh_j_others)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
MH_job_percent<-adv_data%>%
select(shiptocustomernumber)%>%
distinct()%>%
left_join(index,by=c("shiptocustomernumber"="advantagecustomerid"))%>%
mutate(clickshareuserid=as.numeric(clickshareuserid))%>%
group_by(shiptocustomernumber)%>%
left_join(business_job_adv,by=c("clickshareuserid"="clickshareuserid"))%>%
mutate(jobfunction=as.numeric(jobfunction))%>%
mutate(jobfunction=ifelse(is.na(jobfunction),99,jobfunction))%>%
left_join(mh_j,by=c("jobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"unknown",Value))%>%
group_by(shiptocustomernumber)%>%
mutate(min_job=min(jobfunction))%>%
filter(jobfunction==min_job)%>%
ungroup()%>%
select(shiptocustomernumber,Value)%>%
distinct()%>%
group_by(Value)%>%
summarise(`Active Customers`=n_distinct(shiptocustomernumber))%>%
arrange(desc(`Active Customers`))%>%
ungroup()%>%
mutate(`Job Title`=Value)%>%
select(-Value)%>%
mutate(`Total Subscribers`=sum(`Active Customers`))%>%
top_n(10,`Active Customers`)%>%
mutate(Brand="MH")%>%
select(Brand,`Job Title`,`Active Customers`)%>%
filter(!str_detect(`Job Title`,'Other hospital/healthcare executives not listed above'))%>%
top_n(5,`Active Customers`)%>%
mutate(`Total Customers`=mh_totals-mh_j_others)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
j_p_bind<-rbind(cny_job_percent,ccb_job_percent,MH_job_percent)
j_p_bind%>%
ggplot(aes(reorder(`Job Title`,`Share of Customers`),`Share of Customers`,label=`Share of Customers`,fill=Brand))+geom_bar(position="dodge",stat="identity")+geom_text(position="dodge",hjust=-0.1,size=2.5)+theme_minimal()+xlab("Job Title")+ylab("Share of Active Non-Other Customers")+labs(title="Share of Job Titles Across Brands")+facet_grid(~Brand,space="free_x")+coord_flip()
ccb_job_percent<-pelcro_table%>%
select(customeraccountid,businessunitcode)%>%
filter(businessunitcode=="CCB")%>%
filter(str_detect(productname,"Health"))%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
select(customeraccountid,metadatacrainjobfunction)%>%
distinct()%>%
group_by(customeraccountid)%>%
left_join(ccb_j,by=c("metadatacrainjobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Misc titles including Government",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(`Total Customers`=ccb_totals-ccb_j_other)%>%
top_n(10,n)%>%
mutate(Brand="CCB")%>%
mutate(`Job Title`=Value,
`Active Customers`=n)%>%
select(-c(Value,n))%>%
select(Brand,`Job Title`,`Active Customers`,`Total Customers`)%>%
filter(!str_detect(`Job Title`,"Misc titles including"))%>%
top_n(5,`Active Customers`)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
ccb_job_percent<-pelcro_table%>%
select(customeraccountid,businessunitcode,productname)%>%
filter(businessunitcode=="CCB")%>%
filter(str_detect(productname,"Health"))%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
select(customeraccountid,metadatacrainjobfunction)%>%
distinct()%>%
group_by(customeraccountid)%>%
left_join(ccb_j,by=c("metadatacrainjobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Misc titles including Government",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(`Total Customers`=ccb_totals-ccb_j_other)%>%
top_n(10,n)%>%
mutate(Brand="CCB")%>%
mutate(`Job Title`=Value,
`Active Customers`=n)%>%
select(-c(Value,n))%>%
select(Brand,`Job Title`,`Active Customers`,`Total Customers`)%>%
filter(!str_detect(`Job Title`,"Misc titles including"))%>%
top_n(5,`Active Customers`)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
j_p_bind<-rbind(cny_job_percent,ccb_job_percent,MH_job_percent)
j_p_bind%>%
ggplot(aes(reorder(`Job Title`,`Share of Customers`),`Share of Customers`,label=`Share of Customers`,fill=Brand))+geom_bar(position="dodge",stat="identity")+geom_text(position="dodge",hjust=-0.1,size=2.5)+theme_minimal()+xlab("Job Title")+ylab("Share of Active Non-Other Customers")+labs(title="Share of Job Titles Across Brands")+facet_grid(~Brand,space="free_x")+coord_flip()
ccb_j_other<-(pelcro_table%>%
select(customeraccountid,businessunitcode,productname)%>%
filter(businessunitcode=="CCB")%>%
filter(str_detect(productname,"Health"))%>%
distinct()%>%
left_join(pelcro_customer_data_j,by=c("customeraccountid"="customeraccountid"))%>%
left_join(ccb_pelcro_job_index,by=c("metadatacrainjobfunction"="metadatacrainjobfunction"))%>%
mutate(metadatacrainjobfunction=as.numeric(metadatacrainjobfunction))%>%
select(customeraccountid,metadatacrainjobfunction)%>%
distinct()%>%
left_join(ccb_j,by=c("metadatacrainjobfunction"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Misc titles including Government",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(total=ccb_totals)%>%
top_n(10,n)%>%
mutate(`Job Title`=Value,
`Active Customers`=n)%>%
select(-c(Value,n))%>%
select(`Job Title`,`Active Customers`,total)%>%
filter(str_detect(`Job Title`,"Misc titles including")))$`Active Customers`
mh_b_other<-(adv_data%>%
select(shiptocustomernumber)%>%
distinct()%>%
left_join(index,by=c("shiptocustomernumber"="advantagecustomerid"))%>%
mutate(clickshareuserid=as.numeric(clickshareuserid))%>%
left_join(business_job_adv,by=c("clickshareuserid"="clickshareuserid"))%>%
left_join(mh_b,by=c("busind"="ID"))%>%
group_by(shiptocustomernumber)%>%
mutate(Value=ifelse(str_detect(Value,"Other Healthcare"),"Other Healthcare Organization",Value))%>%
mutate(v_check=ifelse(Value=="unknown"|is.na(Value)|str_detect(Value,"Other Healthcare")|str_detect(Value,"Undefined"),0,1))%>%
mutate(Value=ifelse(Value=="unknown","Other Healthcare Organization",Value))%>%
mutate(max_v=max(v_check))%>%
filter(v_check==max_v)%>%
mutate(Value=ifelse(is.na(Value),"Other Healthcare Organization",Value))%>%
select(shiptocustomernumber,Value)%>%
distinct()%>%
ungroup()%>%
group_by(Value)%>%
summarise(`Active Customers`=n_distinct(shiptocustomernumber,na.rm=TRUE))%>%
arrange(desc(`Active Customers`))%>%
ungroup()%>%
mutate(`Business Industry`=Value)%>%
select(-Value)%>%
mutate(`Total Subscribers`=mh_totals)%>%
top_n(10,`Active Customers`)%>%
select(`Business Industry`,`Active Customers`,`Total Subscribers`)%>%
filter(`Business Industry`=="Other Healthcare Organization"))$`Active Customers`
cny_business_percent<-pelcro_table%>%
filter(businessunitcode=="CNY")%>%
filter(productname=='Health Pulse')%>%
select(customeraccountid)%>%
distinct()%>%
left_join(pelcro_customer_data_b,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(cny_b,by=c("metadatacrainbusinessindustry"="Code"))%>%
mutate(Value=ifelse(is.na(Value)|str_detect(Value,"Others Allied"),"Other",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
filter(Value!="Other")%>%
top_n(5,n)%>%
mutate(Brand="CNY Health Pulse")%>%
mutate(`Business Industry`=Value)%>%
mutate(`Active Customers`=n)%>%
mutate(`Total Customers`=cny_totals-cny_b_other)%>%
select(-c(Value,n))%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
ccb_business_percent<-pelcro_table%>%
select(customeraccountid,businessunitcode,productname)%>%
filter(businessunitcode=="CCB")%>%
filter(str_detect(productname,"Health"))%>%
distinct()%>%
left_join(pelcro_customer_data,by=c("customeraccountid"="customeraccountid"))%>%
mutate(metadatacrainbusinessindustry=as.numeric(metadatacrainbusinessindustry))%>%
left_join(ccb_b,by=c("metadatacrainbusinessindustry"="ID"))%>%
mutate(Value=ifelse(is.na(Value),"Others Allied to the Field",Value))%>%
group_by(Value)%>%
summarise(n=n_distinct(customeraccountid))%>%
arrange(desc(n))%>%
mutate(`Business Industry`= Value,
`Active Customers`=n)%>%
mutate(`Total Customers`=ccb_totals-ccb_b_other_counts)%>%
filter(`Business Industry`!="Others Allied to the Field")%>%
top_n(10,`Active Customers`)%>%
mutate(Brand="CCB")%>%
select(Brand,`Business Industry`,`Active Customers`,`Total Customers`)%>%
top_n(5,`Active Customers`)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
MH_business_percent<-adv_data%>%
select(shiptocustomernumber)%>%
distinct()%>%
left_join(index,by=c("shiptocustomernumber"="advantagecustomerid"))%>%
mutate(clickshareuserid=as.numeric(clickshareuserid))%>%
left_join(business_job_adv,by=c("clickshareuserid"="clickshareuserid"))%>%
left_join(mh_b,by=c("busind"="ID"))%>%
group_by(shiptocustomernumber)%>%
mutate(v_check=ifelse(Value=="unknown"|is.na(Value),0,1))%>%
mutate(max_v=max(v_check,na.rm=TRUE))%>%
filter(v_check==max_v)%>%
mutate(Value=ifelse(is.na(Value),"unknown",Value))%>%
group_by(Value)%>%
summarise(`Active Customers`=n_distinct(shiptocustomernumber,na.rm=TRUE))%>%
arrange(desc(`Active Customers`))%>%
ungroup()%>%
mutate(`Business Industry`=Value)%>%
select(-Value)%>%
mutate(`Total Subscribers`=sum(`Active Customers`))%>%
top_n(10,`Active Customers`)%>%
select(`Business Industry`,`Active Customers`,`Total Subscribers`)%>%
filter(`Business Industry`!='unknown'&!str_detect(`Business Industry`,"Other Health"))%>%
top_n(10,`Active Customers`)%>%
mutate(Brand="MH")%>%
select(Brand,`Business Industry`,`Active Customers`)%>%
top_n(5,`Active Customers`)%>%
mutate(`Total Customers`=mh_totals-mh_b_other)%>%
mutate(`Share of Customers`=round(`Active Customers`/`Total Customers`,3)*100)
j_p_bind<-rbind(cny_business_percent,ccb_business_percent,MH_business_percent)
j_p_bind%>%
ggplot(aes(reorder(`Business Industry`,`Share of Customers`),`Share of Customers`,label=`Share of Customers`,fill=Brand))+geom_bar(position="dodge",stat="identity")+geom_text(position="dodge",hjust=-0.1,size=2.5)+theme_minimal()+xlab("Business Industry")+ylab("Share of Active Non-Other Customers")+labs(title="Share of Business Industries Across Brands")+facet_grid(~Brand,space="free_x")+coord_flip()
