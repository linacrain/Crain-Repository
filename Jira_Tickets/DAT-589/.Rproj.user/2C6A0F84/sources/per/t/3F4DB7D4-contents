---
title: "AA Benchmark"
output: html_document
date: "2024-02-06"
---

```{r}
library(tidyverse)
filedir<-setwd("C:\\Users\\andrew.lin\\Downloads\\AA_Content_2022")#2023
filedir<-setwd("C:\\Users\\andrew.lin\\Downloads\\AA Content 2022_true")#true 2022
file_names<-dir(filedir)
print(file_names)
```


```{r}
result<-do.call(rbind,lapply(file_names,read.csv))

data_2022<-do.call(rbind,lapply(file_names_2,read.csv))
```


```{r}
clickshare_index<-AA_2022_2023_Clickshare_Index%>%
  mutate(clickshare=`UID All (v60) (evar60)`)%>%
  mutate(clickshare=ifelse(clickshare=="NO_ID"|is.na(clickshare),NA,clickshare))%>%
  mutate(clickshare=as.double(clickshare))%>%
  select(Visitor_ID,clickshare)%>%
  filter(!is.na(clickshare))%>%
  distinct()
```

```{r}
transformed_visits<-result%>%
  left_join(clickshare_index,by=c("Visitor_ID"="Visitor_ID"))%>%
  filter(!is.na(clickshare))%>%
  mutate(article_check=ifelse(`Content.Type..p29...prop29.`=="article",`Pages`,NA))%>%
  mutate(clickshare_account_change=ifelse(str_detect(Pages,"clickshare")&str_detect(Pages,"add|manage|site|subscriptionCenter|update|reg|update|view"),Pages,NA))%>%
  mutate(customer_service_renewal_settings=ifelse(str_detect(Pages,"subs:Customer-Service/Subscription/SubscriptionRenewalSettings"),Pages,NA))%>%
  mutate(customer_service_suspend=ifelse(str_detect(Pages,"subs:Customer-Service/Subscription/Suspend/"),Pages,NA))%>%
  mutate(customer_service_hard_cancel=ifelse(str_detect(Pages,"subs:Customer-Service/Subscription/Cancel"),Pages,NA))%>%
  mutate(customer_service_soft_cancel=ifelse(str_detect(Pages,"subs:Customer-Service/Subscription/CancelAutomaticRenewal"),Pages,NA))%>%
  mutate(customer_service_subscription_general=ifelse(str_detect(Pages,"subs:Customer-Service/Subscription"),Pages,NA))%>%
  mutate(customer_service_order=ifelse(str_detect(Pages,"subs:Customer-Service/Order"),Pages,NA))%>%
  mutate(customer_service_account=ifelse(str_detect(Pages,"subs:Customer-Service/Account"),Pages,NA))%>%
  select(Date,`Visit.Number`,Visitor_ID,clickshare,article_check,Referrers,Mobile.Device.Type,clickshare_account_change,customer_service_suspend,customer_service_hard_cancel,customer_service_soft_cancel,customer_service_subscription_general,customer_service_order,customer_service_account)%>%
  group_by(Visitor_ID,`Visit.Number`,Date,Mobile.Device.Type,clickshare,Referrers)%>%
  summarise(n_articles=n_distinct(article_check,na.rm=TRUE),
            n_clickshare_account_change=n_distinct(clickshare_account_change,na.rm=TRUE),
            n_cs_hard_cancel=n_distinct(customer_service_hard_cancel,na.rm=TRUE),
            n_cs_soft_cancel=n_distinct(customer_service_soft_cancel,na.rm=TRUE),
            n_cs_sub=n_distinct(customer_service_subscription_general,na.rm=TRUE),
            n_cs_order=n_distinct(customer_service_order,na.rm=TRUE),
            n_cs_account=n_distinct(customer_service_account,na.rm=TRUE),
            n_cs_suspend=n_distinct(customer_service_suspend,na.rm=TRUE))

transformed_2022<-data_2022%>%
  left_join(clickshare_index,by=c("Visitor_ID"="Visitor_ID"))%>%
  filter(!is.na(clickshare))%>%
  mutate(article_check=ifelse(`Content.Type..p29...prop29.`=="article",`Pages`,NA))%>%
  mutate(customer_service_renewal_settings=ifelse(str_detect(`Pages`,"subs:Customer-Service/Subscription/SubscriptionRenewalSettings"),`Pages`,NA))%>%
  mutate(data_center_pages=ifelse(str_detect(Pages,"/datacenter/")&!str_detect(`Content.Type..p29...prop29.`,"section|article"),Pages,NA))%>%
  mutate(customer_service_suspend=ifelse(str_detect(`Pages`,"subs:Customer-Service/Subscription/Suspend/"),`Pages`,NA))%>%
  mutate(customer_service_hard_cancel=ifelse(str_detect(`Pages`,"subs:Customer-Service/Subscription/Cancel"),`Pages`,NA))%>%
  mutate(customer_service_soft_cancel=ifelse(str_detect(`Pages`,"subs:Customer-Service/Subscription/CancelAutomaticRenewal"),`Pages`,NA))%>%
  mutate(customer_service_subscription_general=ifelse(str_detect(`Pages`,"subs:Customer-Service/Subscription"),`Pages`,NA))%>%
  mutate(customer_service_order=ifelse(str_detect(`Pages`,"subs:Customer-Service/Order"),`Pages`,NA))%>%
  mutate(customer_service_account=ifelse(str_detect(`Pages`,"subs:Customer-Service/Account"),`Pages`,NA))%>%
  mutate(clickshare_account_change=ifelse(str_detect(`Pages`,"clickshare")&str_detect(`Pages`,"add|manage|site|subscriptionCenter|update|reg|update|view"),`Pages`,NA))%>%
  select(Date,`Visit.Number`,Visitor_ID,clickshare,article_check,`Mobile.Device.Type`,clickshare_account_change,customer_service_suspend,customer_service_hard_cancel,customer_service_soft_cancel,customer_service_subscription_general,customer_service_order,customer_service_account,Referrers)%>%
  group_by(Visitor_ID,`Visit.Number`,Date,`Mobile.Device.Type`,clickshare,Referrers)%>%
  summarise(n_articles=n_distinct(article_check,na.rm=TRUE),
            n_clickshare_account_change=n_distinct(clickshare_account_change,na.rm=TRUE),
            n_cs_suspend=n_distinct(customer_service_suspend,na.rm=TRUE),
            n_cs_hard_cancel=n_distinct(customer_service_hard_cancel,na.rm=TRUE),
            n_cs_soft_cancel=n_distinct(customer_service_soft_cancel,na.rm=TRUE),
            n_cs_sub=n_distinct(customer_service_subscription_general,na.rm=TRUE),
            n_cs_order=n_distinct(customer_service_order,na.rm=TRUE),
            n_cs_account=n_distinct(customer_service_account,na.rm=TRUE))


cleaned_2022_transformed<-transformed_visits%>%
  mutate(`Visit Number`=as.double(Visit.Number),
         `Mobile Device Type`=Mobile.Device.Type)%>%
  ungroup()%>%
  select(Visitor_ID,`Visit.Number`,Date,`Mobile.Device.Type`,Referrers,clickshare,n_articles,n_clickshare_account_change,n_cs_suspend,n_cs_hard_cancel,n_cs_soft_cancel,n_cs_sub,n_cs_order,n_cs_account)

AA_Web_Data_Reduced<-rbind(cleaned_2022_transformed,transformed_2022)
AA_Web_Data_Reduced<-AA_2022_2023_Data_with_data_center

prod <- dbConnect(RPostgres::Postgres(),  
               host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
               port = 5439,
               user = 'aspireuser',
               password = 'Aspirecrainredshift1',
               dbname = 'prod',
               sslmode='require')

zinfo <- dbConnect(RPostgres::Postgres(),  
               host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
               port = 5439,
               user = 'aspireuser',
               password = 'Aspirecrainredshift1',
               dbname = 'zoominfo',
               sslmode='require')

query_2<-'select userid,aa_subscriberid,aad_subscriberid,aar_subscriberid,aaz_subscriberid from staging.clickshare_aa_stg'

clickshare_stuff<-dbGetQuery(prod,query_2)
```

```{r}

clickshare_list<-clickshare_stuff%>%
  mutate(aa_subscriberid=ifelse(aa_subscriberid=='',NA,aa_subscriberid),
         aad_subscriberid=ifelse(aad_subscriberid=='',NA,aad_subscriberid),
         aar_subscriberid=ifelse(aar_subscriberid=='',NA,aar_subscriberid),
         aaz_subscriberid=ifelse(aaz_subscriberid=='',NA,aaz_subscriberid))%>%
         
  mutate(sub_id=coalesce(aa_subscriberid,aad_subscriberid,aar_subscriberid,aaz_subscriberid))%>%
  dplyr::select(userid,sub_id)%>%
  filter(!is.na(sub_id))%>%
  mutate(sub_id=as.double(sub_id))


demo<-"select * from reporting.mv_tbl__customer_demographic_aa_mv__0"


demographics<-dbGetQuery(zinfo,demo)

dem_info<-demographics%>%
  dplyr::select(clickshareusername,clickshareuserid,organization,businddescription,promotesubscriptions,promoteeditorial,promoteevents,promotewebinars,promotethirdparty,promoteadvertising,isactivesubscriber)

dup_annual<-AA_2022_2023_Cust_Records%>%
  filter(DONOR_TYPE=="I")%>%
  filter(EXPIRE_DATE<as.Date("01-01-2024","%m-%d-%Y"))%>%
  filter(TERM==52)%>%
  mutate(CUSTOMER_NUMBER=as.double(CUSTOMER_NUMBER))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(n=n())%>%
  filter(n==2)%>%
  arrange(TERM_NUMBER,.by_group=TRUE)%>%
  mutate(pub_code_level=ifelse(PUB_CODE=="AAD",2,
                               ifelse(PUB_CODE=="AA",1,0)),
         max_pub=max(pub_code_level,na.rm=TRUE),
         )%>%
  mutate(RATE=ifelse(max_pub>0,sum(RATE),RATE))%>%
  mutate(max_term_number=max(TERM_NUMBER))%>%
  mutate(max_term_pub=ifelse(max_pub==2,"AAD",
                             ifelse(max_pub==1,"AA",PUB_CODE)))%>%
  filter(max_term_pub==PUB_CODE)

non_dup_annual<-AA_2022_2023_Cust_Records%>%
  filter(DONOR_TYPE=="I")%>%
  filter(EXPIRE_DATE<as.Date("01-01-2024","%m-%d-%Y"))%>%
  filter(TERM==52)%>%
  mutate(CUSTOMER_NUMBER=as.double(CUSTOMER_NUMBER))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(n=n())%>%
  filter(n==1)

annual_aa_list<-rbind(non_dup_annual,dup_annual)

clean_annual_list<-annual_aa_list%>%
  select(-c(n,pub_code_level,max_pub,max_term_number,max_term_pub))

aa_part_1_annual<-clean_annual_list%>%
  filter(TERM==52)%>%
  mutate(reference_date=if_else(RENEWAL_ORDER_DATE<EXPIRE_DATE&!is.na(RENEWAL_ORDER_DATE),RENEWAL_ORDER_DATE,EXPIRE_DATE))%>%
  left_join(dem_info,by=c("EMAIL_ADDRESS"="clickshareusername"))%>%
  separate(businddescription,into=c('business','business_detail'),sep="-")%>%
  mutate(promote_subscriptions=ifelse(is.na(promotesubscriptions)|promotesubscriptions=="N",0,1),
         promote_editorial=ifelse(is.na(promoteeditorial)|promoteeditorial=="N",0,1),
         promote_events=ifelse(is.na(promoteevents)|promoteevents=="N",0,1),
         promote_third=ifelse(is.na(promotethirdparty)|promotethirdparty=="N",0,1),
         promote_webinar=ifelse(is.na(promotewebinars)|promotewebinars=="N",0,1),
         promote_ads=ifelse(is.na(promoteadvertising)|promoteadvertising=="N",0,1))%>%
  select(-c(promotesubscriptions,promoteeditorial,promoteevents,promotethirdparty,promotewebinars,promoteadvertising))%>%
  left_join(clickshare_list,by=c("CUSTOMER_NUMBER"="sub_id"))%>%
  left_join(AA_Web_Data_Reduced,by=c("userid"="clickshare"))%>%
  mutate(Date=as.Date(Date,"%B %d,%Y"))%>%
  mutate(datediff=as.numeric(difftime(reference_date,Date,units="days")))%>%
  mutate(vis_id_number=paste(Visitor_ID,`Visit.Number`,sep="_"))%>%
  mutate(vis_id_number=ifelse(Date>reference_date|Date<START_DATE,NA,vis_id_number),
         Date=if_else(Date>reference_date|Date<START_DATE,NA,Date),
         `Mobile.Device.Type`=ifelse(Date>reference_date|Date<START_DATE,NA,`Mobile.Device.Type`),
         Referrers=ifelse(Date>reference_date|Date<START_DATE,NA,Referrers),
         n_articles=ifelse(Date>reference_date|Date<START_DATE,NA,n_articles),
         n_clickshare_account_change=ifelse(Date>reference_date|Date<START_DATE,NA,n_clickshare_account_change),
         n_cs_suspend=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_suspend),
         n_cs_hard_cancel=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_hard_cancel),
         n_cs_soft_cancel=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_soft_cancel),
         n_cs_sub=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_sub),
         n_cs_order=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_order),
         n_cs_account=ifelse(Date>reference_date|Date<START_DATE,NA,n_cs_account),
         is_article_visit=ifelse((Date>reference_date|Date<START_DATE)&n_articles<1,NA,1)
         )

annual_long<-aa_part_1_annual%>%
  mutate(visit_other=ifelse(!str_detect(`Mobile.Device.Type`,"Mobile Phone|Other")&!is.na(`Mobile.Device.Type`),1,0),
         visit_mobile=ifelse(`Mobile.Device.Type`=="Mobile Phone"&!is.na(`Mobile.Device.Type`),1,0),
         visit_desktop=ifelse(`Mobile.Device.Type`=="Other"&!is.na(`Mobile.Device.Type`),1,0))%>%
  select(-`Mobile.Device.Type`)%>%
  mutate(contract_time_period=as.numeric(difftime(reference_date,START_DATE,units="days")))%>%
  mutate(START_DATE=as.Date(START_DATE,"%Y-%m-%d"),
         reference_date=as.Date(reference_date,"%Y-%m-%d"))%>%
  mutate(is_former=ifelse(!is.na(RENEWAL_ORDER_DATE)&as.numeric(difftime(RENEWAL_ORDER_DATE,EXPIRE_DATE,units="days"))<31,0,1))%>%
  mutate(date_period=ifelse(datediff>=contract_time_period-30,1,
                            ifelse(datediff<contract_time_period-30&datediff>=contract_time_period-60,2,
                                   ifelse(datediff<contract_time_period-60&datediff>=contract_time_period-90,3,
                                          ifelse(datediff<contract_time_period-90&datediff>=contract_time_period-120,4,
                                                 ifelse(datediff<contract_time_period-120&datediff>=contract_time_period-150,5,
                                                        ifelse(datediff<contract_time_period-150&datediff>=contract_time_period-180,6,
                                                               ifelse(datediff<contract_time_period-180&datediff>=contract_time_period-210,7,
                                                                      ifelse(datediff<contract_time_period-210&datediff>=contract_time_period-240,8,
                                                                             ifelse(datediff<contract_time_period-240&datediff>=contract_time_period-270,9,
                                                                                    ifelse(datediff<contract_time_period-270&datediff>=contract_time_period-300,10,
                                                                                           ifelse(datediff<contract_time_period-300&datediff>=contract_time_period-330,11,12))))))))))))%>%
  mutate(date_period=ifelse(is.na(vis_id_number),NA,date_period))%>%
  select(-c(contract_time_period,datediff,Visitor_ID,`Visit.Number`))%>%
  ungroup()%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(most_recent_date=max(Date,na.rm=TRUE))%>%
  mutate(recency=as.numeric(difftime(reference_date,most_recent_date,units="days")))%>%
  select(-most_recent_date)%>%
  ungroup()%>%
  group_by(CUSTOMER_NUMBER,TERM,ORDER_NUMBER,RENEWAL_ORDER_DATE,EMAIL_ADDRESS,TERM_NUMBER,IS_AUTO_RENEW,RATE,START_DATE,reference_date,PUB_CODE,business,business_detail,promote_subscriptions,promote_editorial,promote_events,promote_third,promote_webinar,promote_ads,recency,date_period,is_former)%>%
  summarise(articles=sum(n_articles,na.rm=TRUE),
            clickshare_page_account=sum(n_clickshare_account_change,na.rm=TRUE),
            cust_service_suspend=sum(n_cs_suspend,na.rm=TRUE),
            cust_service_hard_cancel=sum(n_cs_hard_cancel,na.rm=TRUE),
            cust_service_soft_cancel=sum(n_cs_sub,na.rm=TRUE),
            cust_service_sub=sum(n_cs_sub,na.rm=TRUE),
            cust_service_order=sum(n_cs_order,na.rm=TRUE),
            cust_service_account=sum(n_cs_account,na.rm=TRUE),
            n_article_visits=sum(is_article_visit,na.rm=TRUE))
  
annual_long

write.csv(annual_long,"AA_Article_Visit_Velocity_Analysis.csv")
```







```{r}
sd_analysis<-aa_part_1_annual%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(most_recent_date=max(Date,na.rm=TRUE))%>%
  mutate(recency=as.numeric(difftime(reference_date,most_recent_date,units="days")))%>%
  mutate(visit_other=ifelse(!str_detect(`Mobile.Device.Type`,"Mobile Phone|Other")&!is.na(`Mobile.Device.Type`),1,0),
         visit_mobile=ifelse(`Mobile.Device.Type`=="Mobile Phone"&!is.na(`Mobile.Device.Type`),1,0),
         visit_desktop=ifelse(`Mobile.Device.Type`=="Other"&!is.na(`Mobile.Device.Type`),1,0))%>%
  select(-`Mobile.Device.Type`)%>%
  mutate(contract_time_period=as.numeric(difftime(reference_date,START_DATE,units="days")))%>%
  mutate(START_DATE=as.Date(START_DATE,"%Y-%m-%d"),
         reference_date=as.Date(reference_date,"%Y-%m-%d"))%>%
  mutate(is_former=ifelse(!is.na(RENEWAL_ORDER_DATE)&as.numeric(difftime(RENEWAL_ORDER_DATE,EXPIRE_DATE,units="days"))<31,0,1))%>%
  mutate(article_Date=if_else(!is.na(n_articles)&n_articles>0,Date,NA))%>%
  arrange(article_Date,.by_group=TRUE)%>%
  mutate(article_date_lag=lag(article_Date))%>%
  mutate(days_between=as.numeric(difftime(Date,article_date_lag,units="days")))%>%
  ungroup()%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER,IS_AUTO_RENEW,RENEWAL_ORDER_DATE,reference_date,START_DATE,is_former,PUB_CODE,RATE,TERM_NUMBER,recency,business,most_recent_date)%>%
  summarise(sd_days_between=sd(days_between,na.rm=TRUE),
            n_article_visits=n_distinct(article_Date,na.rm=TRUE),
            n_articles=sum(n_articles,na.rm=TRUE),
            n_clickshare_account_change=sum(n_clickshare_account_change,na.rm=TRUE),
            n_cs_suspend=sum(n_cs_suspend,na.rm=TRUE),
            n_cs_hard_cancel=sum(n_cs_hard_cancel,na.rm=TRUE),
            n_cs_soft_cancel=sum(n_cs_soft_cancel,na.rm=TRUE),
            n_cs_sub=sum(n_cs_sub,na.rm=TRUE),
            n_cs_order=sum(n_cs_order,na.rm=TRUE),
            n_cs_account=sum(n_cs_account,na.rm=TRUE)
            )

aa_part_1_annual%>%
  filter(CUSTOMER_NUMBER=="5391137")%>%
  arrange(Date,.by_group=TRUE)%>%
  mutate(date_lag=lag(Date))%>%
  mutate(days_between=as.numeric(difftime(Date,date_lag,units="days")))

sd_analysis%>%
  ungroup()%>%
  mutate(did_churn=ifelse(is_former==1|is.na(RENEWAL_ORDER_DATE),1,0))%>%
  mutate(did_churn=as.factor(did_churn))%>%
    mutate(sd_cat=ifelse(n_article_visits==0,"No Visits",
                       ifelse(n_article_visits<=2,"<= 2 Visits",
                            
                       ifelse(sd_days_between<=7,"Weekly SD",
                       ifelse(sd_days_between<=14,"Bi Weekly",
                       "Bi Weekly +")))))%>%
  group_by(did_churn,sd_cat)%>%
  summarise(n=n_distinct(paste(CUSTOMER_NUMBER,ORDER_NUMBER)))%>%
  group_by(sd_cat)%>%
  mutate(total=sum(n))%>%
  mutate(churn_percent=n/total)%>%
  filter(did_churn==1)%>%
  arrange(churn_percent)
  
nn_data_2<-sd_analysis%>%
  mutate(recency=ifelse(is.infinite(recency),as.numeric(difftime(reference_date,START_DATE,units="days")),recency))%>%mutate(did_churn=ifelse(is_former==1|is.na(RENEWAL_ORDER_DATE),1,0))%>%
  mutate(sd_cat=ifelse(n_article_visits==0,"no_visits",
                       ifelse(n_article_visits<=2,"less_than_2_visits",
                            
                       ifelse(sd_days_between<=7,"weekly_sd",
                       ifelse(sd_days_between<=14,"bi_weekly",
                       "bi_weekly_plus")))))%>%
  mutate(IS_AUTO_RENEW=ifelse(IS_AUTO_RENEW=="Y",1,0),
         PUB_CODE=as.factor(PUB_CODE),
         n_cs_cancel_page=n_cs_hard_cancel+n_cs_soft_cancel+n_cs_suspend,
         n_cs_other=n_cs_sub+n_cs_order+n_cs_account,
         sd_cat=as.factor(sd_cat))%>%
  mutate(business=ifelse(str_detect(business,"Other|unknown")|is.na(business),"Other/Unknown",business))%>%
  mutate(business=ifelse(!str_detect(business,"Advertising Agency|Other|Media|Advertising|Univ|Entertainment|Consumer|Financial|Retail"),"Other_industry",business))%>%
  ungroup()%>%
  select(did_churn,PUB_CODE,RATE,TERM_NUMBER,recency,n_article_visits,
         n_articles,n_clickshare_account_change,n_cs_cancel_page,n_cs_other,sd_cat,business,IS_AUTO_RENEW,CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(sd_cat=factor(sd_cat,levels=c("no_visits","less_than_2_visits","weekly_sd","bi_weekly","bi_weekly_plus")))%>%
  mutate(business=as.factor(business))%>%
  mutate(PUB_CODE=as.factor(PUB_CODE))%>%
  group_by(did_churn,sd_cat)%>%
  summarise(n=n_distinct(paste(CUSTOMER_NUMBER,ORDER_NUMBER)))
```


```{r}
nn_data_2
dmy<-dummyVars("~.",data=nn_data_2)
encoded_ds<-data.frame(predict(dmy,newdata=nn_data_2))



library(xgboost)

set.seed(17272)
index<-createDataPartition(nn_data_2$did_churn,p=0.8,list=FALSE)

train<-nn_data_2[index,]
test<-nn_data_2[-index,]

train_matrix<-as.matrix(train[,-1])
test_matrix<-as.matrix(test[,-1])

cv <- xgboost(data = train_matrix, label=train$did_churn,nrounds = 10, nthread = 2, nfold = 5, metrics = ("true_positive"),
             max_depth = 3, eta = 0.3, objective = "binary:logistic",scale_pos_weight=3.046)

train
```

```{r}
preds<-as.numeric(predict(cv,test_matrix)>0.5)

confusionMatrix(as.factor(test$did_churn),as.factor(preds))
```

```{r}
shap_long <- shap.prep(xgb_model = cv, X_train = train_matrix)
shap.plot.summary(shap_long)
```





```{r}
sd_analysis%>%
  mutate(recency=ifelse(is.infinite(recency),as.numeric(difftime(reference_date,START_DATE,units="days")),recency))%>%mutate(did_churn=ifelse(is_former==1|is.na(RENEWAL_ORDER_DATE),1,0))%>%
  mutate(sd_cat=ifelse(n_article_visits==0,"No Visits",
                       ifelse(n_article_visits<=2,"Less than 2 Visits",
                            
                       ifelse(sd_days_between<=7,"Weekly Visits",
                       ifelse(sd_days_between<=14,"Bi Weekly Visits",
                       "Bi Weekly Visits +")))))%>%
  mutate(IS_AUTO_RENEW=ifelse(IS_AUTO_RENEW=="Y",1,0),
         PUB_CODE=as.factor(PUB_CODE),
         n_cs_cancel_page=n_cs_hard_cancel+n_cs_soft_cancel+n_cs_suspend,
         n_cs_other=n_cs_sub+n_cs_order+n_cs_account,
         sd_cat=as.factor(sd_cat))%>%
  mutate(business=ifelse(str_detect(business,"Other|unknown")|is.na(business),"Other/Unknown",business))%>%
  mutate(business=ifelse(!str_detect(business,"Advertising Agency|Other|Media|Advertising|Univ|Entertainment|Consumer|Financial|Retail"),"Other_industry",business))%>%
  ungroup()%>%
  group_by(did_churn,sd_cat)%>%
  summarise(n=n_distinct(paste(CUSTOMER_NUMBER,ORDER_NUMBER)))%>%
  group_by(sd_cat)%>%
  mutate(total=sum(n))%>%
  mutate(churn_percent=n/total)%>%
  filter(did_churn==1)%>%
  arrange(churn_percent)%>%
  ggplot(aes(reorder(sd_cat,churn_percent),round(churn_percent*100),fill="red",label=round(churn_percent*100)))+geom_bar(stat="identity",position="dodge")+coord_flip()+theme_minimal()+xlab("Days betwen Visits with Article Consumption")+ylab("Percentage of Churned Users")+geom_label()
```

```{r}
```






```{r}
annual_long<-AA_Article_Visit_Velocity_Analysis

annual_data_set<-annual_long%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(total_cust_cancel=cust_service_hard_cancel+cust_service_soft_cancel+cust_service_suspend,
         total_cust_service_non_cancel=cust_service_order+cust_service_account+cust_service_sub,
         total_clickshare_pages=sum(clickshare_page_account))%>%
  mutate(total_cust_cancel=sum(total_cust_cancel),
         total_cust_service_non_cancel=sum(total_cust_service_non_cancel))%>%
  select(-c(articles,clickshare_page_account,cust_service_suspend,cust_service_hard_cancel,cust_service_soft_cancel,cust_service_sub,cust_service_order,cust_service_account))%>%
  pivot_wider(names_from=date_period,values_from="n_article_visits",names_sep="_",id_cols=c(CUSTOMER_NUMBER,TERM,ORDER_NUMBER,RENEWAL_ORDER_DATE,EMAIL_ADDRESS,TERM_NUMBER,IS_AUTO_RENEW,RATE,START_DATE,reference_date,PUB_CODE,business,business_detail,promote_subscriptions,promote_editorial,promote_events,promote_third,promote_webinar,promote_ads,recency,total_cust_cancel,total_cust_service_non_cancel,total_clickshare_pages,is_former))%>%
  mutate(across(where(is.numeric),~replace_na(.x,0)))%>%
  group_by(CUSTOMER_NUMBER,TERM_NUMBER,TERM,PUB_CODE,ORDER_NUMBER,RENEWAL_ORDER_DATE,reference_date,START_DATE,RATE,IS_AUTO_RENEW,business,business_detail,promote_subscriptions,promote_editorial,promote_events,promote_third,promote_webinar,promote_ads,recency,total_cust_cancel,total_cust_service_non_cancel,total_clickshare_pages,is_former)%>%
  summarise(article_visits_01=sum(`1`),
            article_visits_02=sum(`2`),
            article_visits_03=sum(`3`),
            article_visits_04=sum(`4`),
            article_visits_05=sum(`5`),
            article_visits_06=sum(`6`),
            article_visits_07=sum(`7`),
            article_visits_08=sum(`8`),
            article_visits_09=sum(`9`),
            article_visits_10=sum(`10`),
            article_visits_11=sum(`11`),
            article_visits_12=sum(`12`),
            articles_visit_NA=sum(`NA`))%>%
  select(-articles_visit_NA)%>%
  ungroup()%>%
  mutate(business=ifelse(str_detect(business,"Other|unknown")|is.na(business),"Other/Unknown",business))%>%
  mutate(business=ifelse(!str_detect(business,"Advertising Agency|Other|Media|Advertising|Univ|Entertainment|Consumer|Financial|Retail"),"Other_industry",business))%>%
  mutate(did_churn=ifelse(!is.na(RENEWAL_ORDER_DATE)&is_former!=1,0,1))%>%
  mutate(PUB_CODE=as.factor(PUB_CODE),
         IS_AUTO_RENEW=ifelse(IS_AUTO_RENEW=="Y",1,0),
         business=as.factor(business))%>%
  mutate(recency=ifelse(is.infinite(recency),as.numeric(difftime(reference_date,START_DATE,units="days")),recency))%>%
  select(-c(business_detail,promote_subscriptions,promote_editorial,promote_events,promote_third,promote_webinar,promote_ads,RENEWAL_ORDER_DATE,reference_date,START_DATE,TERM,is_former))
```


```{r}
annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(is_first_term,PUB_CODE)%>%
  mutate(mean_visits_01=mean(article_visits_01),
         mean_visits_02=mean(article_visits_02),
         mean_visits_03=mean(article_visits_03),
         mean_visits_04=mean(article_visits_04),
         mean_visits_05=mean(article_visits_05),
         mean_visits_06=mean(article_visits_06),
         mean_visits_07=mean(article_visits_07),
         mean_visits_08=mean(article_visits_08),
         mean_visits_09=mean(article_visits_09),
         mean_visits_10=mean(article_visits_10),
         mean_visits_11=mean(article_visits_11),
         mean_visits_12=mean(article_visits_12))%>%
  mutate(dev_from_mean_01=article_visits_01-mean_visits_01,
         dev_from_mean_02=article_visits_02-mean_visits_02,
         dev_from_mean_03=article_visits_03-mean_visits_03,
         dev_from_mean_04=article_visits_04-mean_visits_04,
         dev_from_mean_05=article_visits_05-mean_visits_05,
         dev_from_mean_06=article_visits_06-mean_visits_06,
         dev_from_mean_07=article_visits_07-mean_visits_07,
         dev_from_mean_08=article_visits_08-mean_visits_08,
         dev_from_mean_09=article_visits_09-mean_visits_09,
         dev_from_mean_10=article_visits_10-mean_visits_10,
         dev_from_mean_11=article_visits_11-mean_visits_11,
         dev_from_mean_12=article_visits_12-mean_visits_12)%>%
  mutate(sd_visits_01=sd(article_visits_01),
         sd_visits_02=sd(article_visits_02),
         sd_visits_03=sd(article_visits_03),
         sd_visits_04=sd(article_visits_04),
         sd_visits_05=sd(article_visits_05),
         sd_visits_06=sd(article_visits_06),
         sd_visits_07=sd(article_visits_07),
         sd_visits_08=sd(article_visits_08),
         sd_visits_09=sd(article_visits_09),
         sd_visits_10=sd(article_visits_10),
         sd_visits_11=sd(article_visits_11),
         sd_visits_12=sd(article_visits_12))%>%
  mutate(sd_from_mean_01=round(dev_from_mean_01/sd_visits_01,digits=1),
         sd_from_mean_02=round(dev_from_mean_02/sd_visits_02,digits=1),
         sd_from_mean_03=round(dev_from_mean_03/sd_visits_03,digits=1),
         sd_from_mean_04=round(dev_from_mean_04/sd_visits_04,digits=1),
         sd_from_mean_05=round(dev_from_mean_05/sd_visits_05,digits=1),
         sd_from_mean_06=round(dev_from_mean_06/sd_visits_06,digits=1),
         sd_from_mean_07=round(dev_from_mean_07/sd_visits_07,digits=1),
         sd_from_mean_08=round(dev_from_mean_08/sd_visits_08,digits=1),
         sd_from_mean_09=round(dev_from_mean_09/sd_visits_09,digits=1),
         sd_from_mean_10=round(dev_from_mean_10/sd_visits_10,digits=1),
         sd_from_mean_11=round(dev_from_mean_11/sd_visits_11,digits=1),
         sd_from_mean_12=round(dev_from_mean_12/sd_visits_12,digits=1))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  gather(key="month",value="sd_from_mean",sd_from_mean_01:sd_from_mean_12)%>%
  mutate(month=as.factor((str_sub(month,-2,-1))))%>%
  mutate(did_churn=as.factor(did_churn))%>%
  arrange(month,.by_group=TRUE)%>%
  group_by(did_churn,month)%>%
  mutate(mean_sd_from_mean=mean(sd_from_mean))%>%
  ggplot(aes(month,mean_sd_from_mean,fill=did_churn))+geom_bar(stat="identity",position="dodge")+theme_minimal()+coord_flip()
```

```{r}
annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(is_first_term,PUB_CODE)%>%
  mutate(mean_visits_01=mean(article_visits_01),
         mean_visits_02=mean(article_visits_02),
         mean_visits_03=mean(article_visits_03),
         mean_visits_04=mean(article_visits_04),
         mean_visits_05=mean(article_visits_05),
         mean_visits_06=mean(article_visits_06),
         mean_visits_07=mean(article_visits_07),
         mean_visits_08=mean(article_visits_08),
         mean_visits_09=mean(article_visits_09),
         mean_visits_10=mean(article_visits_10),
         mean_visits_11=mean(article_visits_11),
         mean_visits_12=mean(article_visits_12))%>%
  mutate(dev_from_mean_01=article_visits_01-mean_visits_01,
         dev_from_mean_02=article_visits_02-mean_visits_02,
         dev_from_mean_03=article_visits_03-mean_visits_03,
         dev_from_mean_04=article_visits_04-mean_visits_04,
         dev_from_mean_05=article_visits_05-mean_visits_05,
         dev_from_mean_06=article_visits_06-mean_visits_06,
         dev_from_mean_07=article_visits_07-mean_visits_07,
         dev_from_mean_08=article_visits_08-mean_visits_08,
         dev_from_mean_09=article_visits_09-mean_visits_09,
         dev_from_mean_10=article_visits_10-mean_visits_10,
         dev_from_mean_11=article_visits_11-mean_visits_11,
         dev_from_mean_12=article_visits_12-mean_visits_12)%>%
  mutate(sd_visits_01=sd(article_visits_01),
         sd_visits_02=sd(article_visits_02),
         sd_visits_03=sd(article_visits_03),
         sd_visits_04=sd(article_visits_04),
         sd_visits_05=sd(article_visits_05),
         sd_visits_06=sd(article_visits_06),
         sd_visits_07=sd(article_visits_07),
         sd_visits_08=sd(article_visits_08),
         sd_visits_09=sd(article_visits_09),
         sd_visits_10=sd(article_visits_10),
         sd_visits_11=sd(article_visits_11),
         sd_visits_12=sd(article_visits_12))%>%
  mutate(sd_from_mean_01=round(dev_from_mean_01/sd_visits_01,digits=1),
         sd_from_mean_02=round(dev_from_mean_02/sd_visits_02,digits=1),
         sd_from_mean_03=round(dev_from_mean_03/sd_visits_03,digits=1),
         sd_from_mean_04=round(dev_from_mean_04/sd_visits_04,digits=1),
         sd_from_mean_05=round(dev_from_mean_05/sd_visits_05,digits=1),
         sd_from_mean_06=round(dev_from_mean_06/sd_visits_06,digits=1),
         sd_from_mean_07=round(dev_from_mean_07/sd_visits_07,digits=1),
         sd_from_mean_08=round(dev_from_mean_08/sd_visits_08,digits=1),
         sd_from_mean_09=round(dev_from_mean_09/sd_visits_09,digits=1),
         sd_from_mean_10=round(dev_from_mean_10/sd_visits_10,digits=1),
         sd_from_mean_11=round(dev_from_mean_11/sd_visits_11,digits=1),
         sd_from_mean_12=round(dev_from_mean_12/sd_visits_12,digits=1))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  gather(key="month",value="dev_from_mean",dev_from_mean_01:dev_from_mean_12)%>%
  mutate(month=as.factor((str_sub(month,-2,-1))))%>%
  mutate(did_churn=as.factor(did_churn))%>%
  arrange(month,.by_group=TRUE)%>%
  group_by(did_churn,month)%>%
  mutate(mean_dev_from_mean=mean(dev_from_mean))%>%
  ggplot(aes(month,mean_dev_from_mean,fill=did_churn))+geom_bar(stat="identity",position="dodge")+theme_minimal()+coord_flip()
```

```{r}
annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(CUSTOMER_NUMBER)%>%
  mutate(rolling_avg_02=(article_visits_01+article_visits_02)/2,
         rolling_avg_03=(article_visits_01+article_visits_02+article_visits_03)/3,
         rolling_avg_04=(article_visits_01+article_visits_02+article_visits_03+article_visits_04)/4,
         rolling_avg_05=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05)/5,
         rolling_avg_06=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06)/6,
         rolling_avg_07=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07)/7,
         rolling_avg_08=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08)/8,
         rolling_avg_09=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09)/9,
         rolling_avg_10=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10)/10,
         rolling_avg_11=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11)/11,
         rolling_avg_12=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11+article_visits_12)/12)%>%
  mutate(delta_02=article_visits_02-article_visits_01,
         delta_03=article_visits_03-rolling_avg_02,
         delta_04=article_visits_04-rolling_avg_03,
         delta_05=article_visits_05-rolling_avg_04,
         delta_06=article_visits_06-rolling_avg_05,
         delta_07=article_visits_07-rolling_avg_06,
         delta_08=article_visits_08-rolling_avg_07,
         delta_09=article_visits_09-rolling_avg_08,
         delta_10=article_visits_10-rolling_avg_09,
         delta_11=article_visits_11-rolling_avg_10,
         delta_12=article_visits_12-rolling_avg_11)%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  gather(key="month",value="dev_from_rolling_avg",delta_02:delta_12)%>%
  mutate(did_churn=as.factor(did_churn))%>%
  mutate(month=as.numeric((str_sub(month,-2,-1))))%>%
  arrange(month,.by_group=TRUE)%>%
  group_by(month,did_churn)%>%
  summarise(mean_dev=mean(dev_from_rolling_avg))%>%
  ggplot(aes(x=month,y=mean_dev,color=did_churn))+geom_line()+theme_minimal()
  
```
```{r}
annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(rolling_avg_02=(article_visits_01+article_visits_02)/2,
         rolling_avg_03=(article_visits_01+article_visits_02+article_visits_03)/3,
         rolling_avg_04=(article_visits_01+article_visits_02+article_visits_03+article_visits_04)/4,
         rolling_avg_05=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05)/5,
         rolling_avg_06=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06)/6,
         rolling_avg_07=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07)/7,
         rolling_avg_08=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08)/8,
         rolling_avg_09=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09)/9,
         rolling_avg_10=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10)/10,
         rolling_avg_11=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11)/11,
         rolling_avg_12=(article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11+article_visits_12)/12)%>%
  mutate(delta_02=article_visits_02-article_visits_01,
         delta_03=article_visits_03-rolling_avg_02,
         delta_04=article_visits_04-rolling_avg_03,
         delta_05=article_visits_05-rolling_avg_04,
         delta_06=article_visits_06-rolling_avg_05,
         delta_07=article_visits_07-rolling_avg_06,
         delta_08=article_visits_08-rolling_avg_07,
         delta_09=article_visits_09-rolling_avg_08,
         delta_10=article_visits_10-rolling_avg_09,
         delta_11=article_visits_11-rolling_avg_10,
         delta_12=article_visits_12-rolling_avg_11)%>%
  mutate(avg_delta=(delta_02+delta_03+delta_04+delta_05+delta_06+delta_07+delta_08+delta_09+delta_10+delta_11+delta_12)/11)%>%
  mutate(did_churn=as.factor(did_churn))%>%
  ggplot(aes(x=TERM_NUMBER,y=avg_delta,color=did_churn))+geom_point()
```
```{r}
annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(total_article_visits=article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11+article_visits_12)%>%
  mutate(possible_visits=total_article_visits/52)%>%
  mutate(did_churn=as.factor(did_churn))%>%
  ungroup()%>%
  mutate(delta_02=article_visits_02-article_visits_01,
         delta_03=article_visits_03-rolling_avg_02,
         delta_04=article_visits_04-rolling_avg_03,
         delta_05=article_visits_05-rolling_avg_04,
         delta_06=article_visits_06-rolling_avg_05,
         delta_07=article_visits_07-rolling_avg_06,
         delta_08=article_visits_08-rolling_avg_07,
         delta_09=article_visits_09-rolling_avg_08,
         delta_10=article_visits_10-rolling_avg_09,
         delta_11=article_visits_11-rolling_avg_10,
         delta_12=article_visits_12-rolling_avg_11)%>%
  mutate(avg_delta=(delta_02+delta_03+delta_04+delta_05+delta_06+delta_07+delta_08+delta_09+delta_10+delta_11+delta_12)/11)%>%
  mutate(did_churn=as.factor(did_churn))%>%
  ggplot(aes(x=TERM_NUMBER,y=avg_delta,color=did_churn))+geom_point()
```

```{r}
data_set_nn<-annual_data_set%>%
  mutate(is_first_term=ifelse(TERM_NUMBER!=1,1,0))%>%
  group_by(CUSTOMER_NUMBER,ORDER_NUMBER)%>%
  mutate(total_article_visits=article_visits_01+article_visits_02+article_visits_03+article_visits_04+article_visits_05+article_visits_06+article_visits_07+article_visits_08+article_visits_09+article_visits_10+article_visits_11+article_visits_12)%>%
  mutate(avg_article_visits_week=total_article_visits/52)%>%
  ungroup()%>%
  select(did_churn,TERM_NUMBER,RATE,IS_AUTO_RENEW,business,recency,total_cust_cancel,total_cust_service_non_cancel,total_clickshare_pages,avg_article_visits_week)
```

```{r}
data_set_nn
```


Expiramental Process:
Split into 60/30/10 
Try the following setups: 1 Hidden Layer, N Neurons
                          2 Hidden Layers, N/2 + 3N
                          PCA Layers, KNN Neurons
                          1 Hidden Layer, (N+2)/2
                          
                          
One Hot Encode the Cat.                         
```{r}
annual_data_set
dmy<-dummyVars("~.",data=data_set_nn)
encoded_ds<-data.frame(predict(dmy,newdata=data_set_nn))

encoded_ds[,-1]
```

```{r}
nn_data_2
dmy<-dummyVars("~.",data=nn_data_2)
encoded_ds<-data.frame(predict(dmy,newdata=nn_data_2))
encoded_ds
encoded_ds[,-1]
```


Min Max Norm
```{r}
process<-preProcess(as.data.frame(encoded_ds[,-1]),method=c("range"))
norm_scale <- predict(process, as.data.frame(encoded_ds[,-1]))
did_churn<-encoded_ds[,1]
std_encoded_annual_ds<-cbind(norm_scale,did_churn)

std_encoded_annual_ds
```
PCA = 7 hidden layers

```{r}
aa_pca<-prcomp(std_encoded_annual_ds,center=FALSE,scale.=FALSE)
summary(aa_pca)
eig.val<-get_eigenvalue(aa_pca)
eig.val

fviz_pca_var(aa_pca, col.var = "black")
```
PCOMP 1 = 3 NEURONS
```{r}
pcomp_1<-aa_pca$x[,1]
wss <- function(k) {
  kmeans(pcomp_1, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```
Neurons = 3
```{r}
pcomp_2<-aa_pca$x[,2]
wss <- function(k) {
  kmeans(pcomp_2, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```
PC COMP 3 NEURONS = 3
```{r}
pcomp_3<-aa_pca$x[,3]
wss <- function(k) {
  kmeans(pcomp_3, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```
PC 4 Neurons = 4
```{r}
pcomp_4<-aa_pca$x[,4]
wss <- function(k) {
  kmeans(pcomp_4, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```
PC 5 = 2 NEURONS
```{r}
pcomp_5<-aa_pca$x[,5]
wss <- function(k) {
  kmeans(pcomp_5, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

PC 6 = 3 NEURONS
```{r}
pcomp_6<-aa_pca$x[,6]
wss <- function(k) {
  kmeans(pcomp_6, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```
PC 7 = 3 NEURONS
```{r}
pcomp_7<-aa_pca$x[,7]
wss <- function(k) {
  kmeans(pcomp_7, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

```{r}
pcomp_8<-aa_pca$x[,8]
wss <- function(k) {
  kmeans(pcomp_8, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

```{r}
pcomp_9<-aa_pca$x[,9]
wss <- function(k) {
  kmeans(pcomp_9, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

```{r}
pcomp_10<-aa_pca$x[,10]
wss <- function(k) {
  kmeans(pcomp_10, k, nstart = 10 )$tot.withinss
}
k.values <- 1:30
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

10 fold CV for 7 Hidden Layer NN
```{r}
set.seed(17272)
index<-createDataPartition(std_encoded_annual_ds$did_churn,p=0.8,list=FALSE)

train<-std_encoded_annual_ds[index,]
test<-std_encoded_annual_ds[-index,]

write.csv(train,"aa_annual_train.csv")
write.csv(test,"aa_annual_test.csv")


n<-names(train)
 
k<-10
f <- as.formula(paste("did_churn ~",  
                paste(n[! n%in%"did_churn"],  
                collapse = "+"))) 

relu <- NULL

mcc.list<- NULL
for(i in 1:k){
  index_cv<-createDataPartition(train$did_churn,p=0.9,list=FALSE)
  train.cv<-train[index_cv,]
  test.cv<-test[index_cv,]
  
  nn <- neuralnet(f,data=train.cv,hidden=c(3,3,3,4,2,3,3),linear.output=FALSE,err.fct='ce',likelihood=TRUE)
  
  pred<-as.numeric(predict(nn,test.cv)>0.5)
  actual<-as.numeric(test.cv$did_churn)
  print(i)
  mcc.list[i]<-mcc(actual,pred)
}

nn <- neuralnet(f,data=train,hidden=c(3,3,3,4,2,3,3),linear.output=FALSE,err.fct='ce',likelihood=TRUE)
actual<-as.numeric(test.cv$did_churn)

cross.entropy(as.numeric(test.cv$did_churn),pred)

mcc(as.numeric(test.cv$did_churn),pred)
nn$act.fct()

relu
```

```{r}
test_pred<-as.numeric(predict(nn,test)>0.5)
actual<-as.numeric(test$did_churn)
mcc(actual,test_pred)


confusionMatrix(as.factor(test_pred),as.factor(actual))
```

```{r}

nn_base<-neuralnet(f,data=train,hidden=c(18),linear.output=FALSE,err.fct='ce',likelihood=TRUE)
test_pred_base<-as.numeric(predict(nn_base,test)>0.5)
actual<-as.numeric(test$did_churn)
mcc(actual,test_pred_base)


confusionMatrix(as.factor(test_pred_base),as.factor(actual))
```

```{r}
train
test
```




```{r}
model <- keras_model_sequential()
limodel %>%
```
  # Adds a densely-connected layer with 64 units to the model:
  layer_dense(units = 64, activation = 'relu') %>%

  # Add another:
  layer_dense(units = 64, activation = 'relu') %>%

  # Add a softmax layer with 10 output units:
  layer_dense(units = 10, activation = 'softmax')
```


