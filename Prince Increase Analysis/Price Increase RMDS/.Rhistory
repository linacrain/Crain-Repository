group_by(shiptocustomernumber,ordernumber,subscriptionreference,termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
919/1425
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(pubcode)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,termlength,startissuedate,expirationissuedate)%>%
filter(termlength=="Monthly")
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(og_termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
select(og_termlength)%>%
distinct()
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
select(og_termlength)%>%
distinct()
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
distinct()%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(og_termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(og_termlength==4|og_termlength==52)%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-05-01",format="%Y-%m-%d"))%>%
filter(og_termlength==4|og_termlength==52)%>%
distinct()%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(og_termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(og_termlength==4|og_termlength==52)%>%
distinct()%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
group_by(og_termlength)%>%
mutate(renewalrate=ifelse(renewalrate==0&did_renew==FALSE,NA,renewalrate))%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE),
mean_rate=mean(rate,na.rm=TRUE),
mean_renewal_rate=mean(renewalrate,na.rm=TRUE),
mean_termnumber=mean(termnumber))
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(og_termlength==4|og_termlength==52)%>%
group_by(shiptocustomernumber,ordernumber,subscriptionreference,og_termlength,startissuedate,expirationissuedate)%>%
mutate(pub_level=ifelse(publicationcode=="AN2",1,
ifelse(publicationcode=="AN3",3,
ifelse(publicationcode=="AN4",4,2))))%>%
mutate(mpub_level=max(pub_level))%>%
mutate(total_rate=sum(rate),
term_number=max(termnumber))%>%
mutate(renewal_value=ifelse(is.na(renewalordernumber),NA,1))%>%
summarise(pub_level=max(pub_level,na.rm=TRUE),
rate=sum(rate,na.rm=TRUE),
termnumber=max(termnumber,na.rm=TRUE),
did_renew=ifelse(max(renewal_value,na.rm=TRUE)==1,TRUE,FALSE),
renewalrate=sum(renewalrate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE))%>%
mutate(pubcode=ifelse(pub_level==4,"AN4",
ifelse(pub_level==3,"AN3",
ifelse(pub_level==2,"AN1","AN2"))))%>%
ungroup()%>%
summarise(n_distinct_active_contracts=n_distinct(paste(shiptocustomernumber,ordernumber)),
n_renewals=n_distinct(ifelse(did_renew==TRUE,paste(shiptocustomernumber,ordernumber),NA),na.rm=TRUE))
an_p_data
an_p_data%>%
filter(donortype=="I")%>%
filter(!is.na(adv_subid))%>%
filter(!adv_subid%in%an_adv_data$subscriptionreference)%>%
filter(adv_subid!=pelcro_subid)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)
an_adv_data%>%
distinct()%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))
an_p_data
an_p_data%>%
filter(adv_subid==24927928)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)
an_p_data
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber=original_adv_cust_value","ordernumber"="ordernumber"))
an_p_data
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
select(shiptocustomernumber,ordernumber,subscriptionreference)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
select(shiptocustomernumber,ordernumber,subscriptionreference)%>%
distinct()
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
select(subscriptionreference)%>%
distinct()
an_p_data%>%
filter(adv_subid==22718114)
an_adv_data%>%
filter(subscriptionreference==22718114)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
select(subscriptionreference)%>%
distinct()
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
distinct()
an_adv_data%>%
filter(subscriptionreference==24126495)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)
an_adv_data%>%
distinct()%>%
filter(!subscriptionreference%in%an_p_data$adv_subid)%>%
filter(expirationissuedate>=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
filter(startissuedate<=as.Date("2023-12-15",format="%Y-%m-%d"))%>%
left_join(an_p_data,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
filter(is.na(brand))%>%
distinct()
an_adv_data%>%
filter(subscriptionreference==24126495)
an__data%>%
filter(subscriptionreference==24126495)
an_p_data%>%
filter(subscriptionreference==24126495)
an_p_data%>%
filter(adv_subid==24126495)
pelcro<-dbGetQuery(prod,"select * from prod.pelcro.subscription where businessunitcode='ANG'")
prod <- dbConnect(RPostgres::Postgres(),
host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
port = 5439,
user = 'aspireuser',
password = 'Aspirecrainredshift1',
dbname = 'prod',
sslmode='require')
pelcro<-dbGetQuery(prod,"select * from prod.pelcro.subscription where businessunitcode='ANG'")
prod
pelcro%>%
filter(!subscriptionid%in%an_p_data$pelcro_subid)
pelcro%>%
filter(!str_detect(productname,"Canada"))
pelcro%>%
filter(!str_detect(productname,"Canada"))%>%
filter(!subscriptionid%in%an_p_data$pelcro_subid)
