---
title: "AN Price Increase"
author: "Andrew Lin"
date: "2024-06-13"
output: html_document
---

```{r}
library(tidyverse)
library(DBI)
library(RPostgres)
library("readr") 

prod <- dbConnect(RPostgres::Postgres(),  
               host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
               port = 5439,
               user = 'aspireuser',
               password = 'Aspirecrainredshift1',
               dbname = 'prod',
               sslmode='require')

an_adv_data<-dbGetQuery(prod,"select * from dev.pelcro_records.advantage_query where owningoffice='ANG'")

pelcro<-dbGetQuery(prod,"select * from prod.pelcro.subscription where businessunitcode='ANG'")

pelcro_invoice<-dbGetQuery(prod,"select * from prod.pelcro.invoice where businessunitcode='ANG'")

an_p_data<-dbGetQuery(prod,"select * from dev.pelcro_records.an where pubcode not like '%Canada%'")

an_query<-dbGetQuery(prod, statement = read_file('AN_Individual_query.sql'))
```

Validation Checking....
```{r}

an_adv_data%>%
  distinct()%>%
  filter(!subscriptionreference%in%an_query$adv_subid)%>%
  left_join(an_query,by=c("shiptocustomernumber"="original_adv_cust_value","ordernumber"="ordernumber"))%>%
  filter(is.na(brand))

pelcro%>%
  filter(!subscriptionid%in%an_query$pelcro_subid)%>%
  filter(!str_detect(productname,"Canada"))%>%
  left_join(pelcro_invoice,by=c("subscriptionid"="susbcriptionid"))%>%
    filter(ispaid==TRUE)

```

AN Digital Only + Digital and Print (Annual) Renewals
```{r}
an_query%>%
  filter(donortype=="I")%>%
  filter(expirationissuedate>=as.Date("01-08-2024",format="%m-%d-%Y")&orderdate<=as.Date("12-15-2023",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  filter(termlength=="Annual")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,ordernumber,orderdate,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,isautorenew)%>%
  filter(rate<=199)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299)|renewalordernumber>0&renewalrate>=rate,paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_undetermined=n_distinct(ifelse(renewalordernumber==0&expirationissuedate>=today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churned=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),rate,NA),na.rm=TRUE),
            mean_termnumber_renewal_pi=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),termnumber,NA),na.rm=TRUE),
            renewal_revenue_pi=sum(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Basic Digital",249,
                                     ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Premium",299,NA)),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_revenue_pi+churn_loss)
            
            
            
```


Monthly Digital
```{r}
an_query%>%
  filter(donortype=="I")%>%
  filter(termlength=="Monthly")%>%
  filter(orderdate<=as.Date("01/15/2024",format="%m/%d/%Y")&termnumber!=1&expirationissuedate>=as.Date("01/15/2024",format="%m/%d/%Y")|orderdate<=as.Date("12/15/2023",format="%m/%d/%Y")&expirationissuedate>=as.Date("01-15-2024",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital")%>%
  filter(expirationissuedate<=today()|(expirationissuedate>=today()&!is.na(renewalordernumber)))%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,pelcro_subid)%>%
  mutate(min_order=min(termnumber))%>%
  filter(termnumber==min_order)%>%
  filter(rate<=20)%>%
  group_by(shiptocustomernumber,ordernumber,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,termlength,isautorenew)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_renewals_no_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate<=rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churn=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            median_rate_renewal_price_increase=median(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            median_rate_churn_price_increase=median(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            mean_termnumber_renewal=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber>0,NA,termnumber),na.rm=TRUE),
            renewal_pi_revenue=sum(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<today(),25,NA),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_pi_revenue+churn_loss)
```
Initial New Orders 
```{r}
an_query%>%
  filter(donortype=="I")%>%
  filter(orderdate>=as.Date("12/15/2023",format="%m/%d/%Y")&termnumber==1)%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,ordernumber,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,startissuedate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,termlength,isautorenew)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals=n_distinct(ifelse(renewalordernumber>0,paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_undetermined_contracts=n_distinct(ifelse(renewalordernumber==0&expirationissuedate>=today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churned=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse(renewalordernumber>0,rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            median_rate_renewal_price_increase=median(ifelse(renewalordernumber>0,rate,NA),na.rm=TRUE),
            median_rate_churn_price_increase=median(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            initial_new_user_revenue=sum(rate))
```


