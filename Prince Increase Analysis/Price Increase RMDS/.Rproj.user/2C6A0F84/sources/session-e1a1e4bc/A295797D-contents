---
title: "Sailthru Analysis"
author: "Andrew Lin"
date: "2024-05-21"
output: html_document
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RPostgres)
library(data.table)
profile_index<-read.csv("final_cleaned_profile_index_2.csv")
final_message<-read.csv("blast_message_opens_012024.csv")
feb_march_index<-read.csv("feb_march_profile_index.csv")
feb_march_blasts<-read.csv("feb_march_blast_messages.csv")



prod <- dbConnect(RPostgres::Postgres(),  
               host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
               port = 5439,
               user = 'aspireuser',
               password = 'Aspirecrainredshift1',
               dbname = 'prod',
               sslmode='require')

clickshare_index<-dbGetQuery(prod,"SELECT userid,createdate,referrer,aa_subscriberid,aad_subscriberid,aar_subscriberid,aaz_subscriberid from prod.staging.clickshare_aa_stg
where createdate>=Date('2024-01-01') and createdate<('2024-04-01')")

clickshare_index<-clickshare_index%>%
  mutate(across(contains("subscriberid"),~ifelse(.==""|is.na(.),NA,.)))%>%
  mutate(aa_subid=as.numeric(coalesce(aa_subscriberid,aad_subscriberid,aar_subscriberid,aaz_subscriberid)))%>%
  select(userid,createdate,aa_subid,referrer)

profile_index<-profile_index%>%
  mutate(csid=as.numeric(vars.csUserId))%>%
  select(-c(vars.csUserId,X))

feb_march_index<-feb_march_index%>%
  mutate(csid=as.numeric(v))%>%
  select(-c(X,v))

final_profile_index<-rbind(profile_index,feb_march_index)%>%
  unique()

write.csv(final_profile_index,"Jan_to_March_Message_Blast_Profile_Index.csv")

clickshare_sailthru_join<-clickshare_index%>%
  left_join(final_profile_index,by=c("userid"="csid"))

clickshare_total<-n_distinct(clickshare_index$userid)

converted_count<-(clickshare_index%>%
  filter(!is.na(aa_subid))%>%
  summarise(n=n_distinct(userid)))$n

conversion_rate<-round(converted_count/clickshare_total*100,3)


final_message<-final_message%>%
  select(-X)

result<-rbind(final_message,feb_march_blasts)
  
message<-as.data.table(unique_message_blast)

message[, n := max(did_open), by = .(profile_id,message_id,blast_id,send_time,send_date)]          
result <- message[did_open == n]                        
result[, n := NULL]                         


relevant_emails<-result%>%
  filter(profile_id%in%clickshare_sailthru_join$id)


grouped_values<-relevant_emails%>%  
  group_by(profile_id)%>%
  summarise(n_distinct_emails=n_distinct(blast_id,message_id,profile_id,send_time),
            n_distinct_dates=n_distinct(send_date),
            n_distinct_blasts=n_distinct(blast_id),
            n_distinct_messages=n_distinct(message_id),
            total_opened_emails=sum(did_open),
            total_clicked_emails=sum(did_click),
            )


```


In Jan 2024, AA had a total of `r clickshare_total` registrations, of which `r converted_count`(`r conversion rate`%) converted to a subscription. 
 
```{r}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  summarise(`Total Customers`=n_distinct(userid),
            `Customers we Emailed`=n_distinct(ifelse(is.na(n_distinct_emails),NA,userid),na.rm=TRUE),
            `Customers who Opened`=n_distinct(ifelse(!is.na(n_distinct_emails)&total_opened_emails>0,userid,NA),na.rm=TRUE),
           `Customers who Opened+Clicked`=n_distinct(ifelse(!is.na(n_distinct_emails)&total_opened_emails>0&total_clicked_emails>0,userid,NA),na.rm=TRUE))

raw_info<-result%>%
  filter(profile_id%in%clickshare_sailthru_join$id)

r_values_avg_per_week<-relevant_emails%>%
  separate(send_time,into=c("date","time"),sep=" ")%>%
  mutate(send_date=as.Date(date,format="%Y-%m-%d"))%>%
  mutate(week = week(ymd(send_date)))%>%
  group_by(profile_id,week)%>%
  summarise(number_emails=n_distinct(paste(blast_id,message_id,profile_id,date,time)),
            total_opens=n_distinct(ifelse(did_open==TRUE,paste(blast_id,message_id,profile_id,date,time),NA),na.rm=TRUE),
            total_open_and_clicked=n_distinct(ifelse(did_open==TRUE&did_click==TRUE,paste(blast_id,message_id,profile_id,date,time),NA),na.rm=TRUE))%>%
  ungroup()%>%
  group_by(profile_id)%>%
  summarise(week=n_distinct(week),
            total_emails=sum(number_emails),
            total_opens=sum(total_opens),
            total_open_and_clicked=sum(total_open_and_clicked))
  


```
What about Converted Users?

```{r}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  filter(!is.na(aa_subid))%>%
  summarise(`Total Customers (Converted)`=n_distinct(userid),
            `Customers we Emailed`=n_distinct(ifelse(is.na(n_distinct_emails),NA,userid),na.rm=TRUE),
            `Customers who Opened`=n_distinct(ifelse(!is.na(n_distinct_emails)&total_opened_emails>0,userid,NA),na.rm=TRUE),
           `Customers who Opened+Clicked`=n_distinct(ifelse(!is.na(n_distinct_emails)&total_opened_emails>0&total_clicked_emails>0,userid,NA),na.rm=TRUE))
```
```{r}
```




```{r}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  filter(!is.na(n_distinct_emails))%>%
  summarise(customers_who_opened=n_distinct(ifelse(total_opened_emails>0,userid,NA),na.rm=TRUE),
            customers_who_opened_and_clicked=n_distinct(ifelse(total_opened_emails>0&total_clicked_emails>0,userid,NA),na.rm=TRUE))
```
```{r}
clickshare_sailthru_join%>%
  left_join(r_values_avg_per_week,b=c("id"="profile_id"))%>%
  filter(!is.na(total_emails))%>%
  group_by(userid)%>%
  summarise(total_weeks=max(week),
            total_emails=sum(total_emails))%>%
  mutate(avg_emails_per_week=total_emails/total_weeks)%>%
  distinct()%>%
  ggplot(aes(avg_emails_per_week))+geom_histogram()+theme_minimal()+xlab("Avg. Emails Per Week")+ylab("Count of Emailed Customers")+scale_x_continuous(breaks = scales::pretty_breaks(n = 10))
  
```

```{r}
clickshare_sailthru_join%>%
  left_join(r_values_avg_per_week,b=c("id"="profile_id"))%>%
  filter(!is.na(total_emails))%>%
  group_by(userid)%>%
  summarise(total_weeks=max(week),
            total_emails=sum(total_emails))%>%
  mutate(avg_emails_per_week=total_emails/total_weeks)%>%
  distinct()%>%
  summary(avg_emails_per_week)
```
```{r}
clickshare_sailthru_join%>%
  left_join(r_values_avg_per_week,b=c("id"="profile_id"))%>%
  filter(!is.na(total_emails))%>%
  group_by(userid)%>%
  summarise(total_weeks=max(week),
            total_emails=sum(total_emails),
            total_opens=sum(total_opens),
            total_open_and_clicked=sum(total_open_and_clicked))%>%
  mutate(avg_emails_per_week=total_emails/total_weeks)%>%
  ggplot(aes(total_emails,total_opens,color=avg_emails_per_week))+geom_point()+theme_minimal()
```
```{r}
clickshare_sailthru_join%>%
  left_join(r_values_avg_per_week,b=c("id"="profile_id"))%>%
  filter(!is.na(total_emails))%>%
  group_by(userid)%>%
  summarise(total_weeks=max(week),
            total_emails=sum(total_emails),
            total_opens=sum(total_opens),
            total_open_and_clicked=sum(total_open_and_clicked))%>%
  mutate(avg_emails_per_week=total_emails/total_weeks)%>%
  mutate(share_of_opened_email=round(total_opens/total_emails*100))%>%
  ggplot(aes(avg_emails_per_week,share_of_opened_email,color=avg_emails_per_week))+geom_point()+theme_minimal()
```

```{r,fig.width=9}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  filter(is.na(n_distinct_emails))%>%
  mutate(referrer=ifelse(is.na(referrer)|referrer=="","Unknown",referrer))%>%
  group_by(referrer)%>%
  summarise(n_users=n_distinct(userid))%>%
  mutate(total_users=sum(n_users))%>%
  mutate(share_of_users=round(n_users/total_users*100,1))%>%
  arrange(desc(share_of_users))%>%
  top_n(10)%>%
  ggplot(aes(reorder(referrer,share_of_users),share_of_users,label=share_of_users,fill="pink"))+geom_bar(stat="identity",position="dodge")+coord_flip()+theme_minimal()+geom_text(vjust=-0.1,position=position_dodge(width=0.9),hjust=-.2)+xlab("Referrer")+ylab("Share of Non-Emailed Customers")+labs(title="Share of Referrers for Non-Emailed Customers")
```

```{r}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  mutate(did_click=ifelse(total_clicked_emails>0,TRUE,FALSE))%>%
  filter(!is.na(n_distinct_emails))%>%
  ggplot(aes(did_click,n_distinct_emails))+geom_boxplot()+theme_minimal()+coord_flip()
```
```{r}
clickshare_sailthru_join%>%
  left_join(grouped_values,by=c("id"="profile_id"))%>%
  mutate(did_click=ifelse(total_clicked_emails>0,TRUE,FALSE))%>%
  mutate(did_purchase=ifelse(!is.na(aa_subid),TRUE,FALSE))%>%
  filter(!is.na(n_distinct_emails))%>%
  filter(did_purchase==TRUE)
  ggplot(aes(did_click,n_distinct_emails))+geom_boxplot()+theme_minimal()+coord_flip()
```

```{r}
clickshare_sailthru_join%>%
  left_join(relevant_emails,by=c("id"="profile_id"))%>%
  mutate(send_time=ymd_hms(send_time))%>%
  filter(send_time>=createdate)%>%
  distinct()%>%
  group_by(userid)%>%
  summarise
```





