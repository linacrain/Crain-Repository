"0","reduced<-ccb_adv_data%>%"
"0","  filter(startissuedate>=as.Date(""2016-01-01"",format=""%Y-%m-%d""))%>%"
"0","  group_by(shiptocustomernumber,ordernumber)%>%"
"0","  mutate(pub_level=ifelse(publicationcode=='CB1',1,"
"0","                          ifelse(publicationcode=='CB2',2,"
"0","                          ifelse(publicationcode=='CB3',3,4))),"
"0","         did_renew=ifelse(is.na(renewalordernumber),0,1),"
"0","         did_renew=max(did_renew))%>%"
"0","  mutate(max_pub=max(pub_level),"
"0","         termnumber=max(termnumber),"
"0","         rate=sum(rate),"
"0","         renewalrate=sum(renewalrate,na.rm=TRUE),"
"0","         )%>%"
"0","  filter(pub_level==max_pub)"
"0",""
"0",""
"0",""
"0","migration_rows<-ccb_autorenew%>%"
"0","  group_by(subscriptionid)%>%"
"0","  arrange(start_date,.by_group=TRUE)%>%"
"0","  mutate(renewalordernumber=lead(ordernumber,order_by=subscriptionid),"
"0","         renewalrate=lead(rate,order_by=subscriptionid),"
"0","         renewalstartdate=lead(start_date,order_by=subscriptionid))%>%"
"0","  ungroup()%>%"
"0","  filter(!is.na(adv_sub_id))%>%"
"0","  group_by(subscriptionid,adv_sub_id,adv_order_number)%>%"
"0","  mutate(min_date=min(start_date))%>%"
"0","  filter(min_date==start_date)"
"0",""
"0","migrated_rows<-reduced%>%"
"0","  left_join(migration_rows,by=c('subscriptionreference'='adv_sub_id','ordernumber'='adv_order_number'))%>%"
"0","  filter(!is.na(rate.y))%>%"
"0","  mutate(original_adv_cust_value=as.numeric(shiptocustomernumber),"
"0","         shiptocustomernumber=as.character(shiptocustomernumber),"
"0","         pubcode=publicationcode.y,"
"0","         termlength=termlength.x,"
"0","         rate=rate.x,"
"0","         orderdate=orderdate.x,"
"0","         brand='CCB',"
"0","         adv_subid=subscriptionreference,"
"0","         pelcro_subid=subscriptionid,"
"0","         isautorenew=isautorenew.x,"
"0","         donortype=donortype.y,"
"0","         renewalordernumber=as.character(renewalordernumber.y),"
"0","         renewalrate=renewalrate.y,"
"0","         renewalstartdate=renewalstartdate.y,"
"0","         ordernumber=as.character(ordernumber)"
"0","         )%>%"
"0","   select(shiptocustomernumber,original_adv_cust_value,ordernumber,orderdate,brand,pubcode,adv_subid,pelcro_subid,termnumber,isautorenew,startissuedate,expirationissuedate,rate,termlength,renewalordernumber,renewalrate,renewalstartdate,donortype)"
"0",""
"0","adv_rows<-reduced%>%"
"0","  ungroup()%>%"
"0","  filter(!ordernumber%in%migrated_rows$ordernumber)%>%"
"0","  group_by(shiptocustomernumber)%>%"
"0","  arrange(termnumber,.by_group=TRUE)"
"0",""
"0",""
"0","advantage_rows<-adv_rows%>%"
"0","  mutate(original_adv_cust_value=as.double(shiptocustomernumber),"
"0","         shiptocustomernumber=as.character(shiptocustomernumber),"
"0","         pubcode=publicationcode,"
"0","         adv_subid=subscriptionreference,"
"0","         pelcro_subid=NA,"
"0","         brand=owningoffice)%>%"
"0","  select(shiptocustomernumber,original_adv_cust_value,ordernumber,orderdate,brand,pubcode,adv_subid,pelcro_subid,termnumber,isautorenew,startissuedate,expirationissuedate,rate,termlength,renewalordernumber,renewalrate,renewalstartdate,donortype)%>%"
"0","  filter(donortype==""I"")"
"0","  "
"0","pelcro_rows<-ccb_autorenew%>%"
"0","  group_by(subscriptionid)%>%"
"0","  arrange(start_date,.by_group=TRUE)%>%"
"0","  mutate(renewalordernumber=lead(ordernumber,order_by=subscriptionid),"
"0","         renewalrate=lead(rate,order_by=subscriptionid),"
"0","         renewalstartdate=lead(start_date,order_by=subscriptionid))%>%"
"0","  ungroup()%>%"
"0","  filter(is.na(adv_sub_id)|!ordernumber%in%migration_rows)%>%"
"0","  group_by(subscriptionid,adv_sub_id,adv_order_number)"
"0",""
"0","migration_termnumber<-migrated_rows%>%"
"0","  group_by(pelcro_subid,original_adv_cust_value)%>%"
"0","  summarise(m=max(termnumber))"
"1","[38;5;232m`summarise()` has grouped output by 'pelcro_subid'. You can override using the `.groups` argument.[39m
"
"0","p_rows<-pelcro_rows%>%"
"0","  group_by(subscriptionid)%>%"
"0","  arrange(start_date,.by_group=TRUE)%>%"
"0","  left_join(migration_termnumber,by=c(""subscriptionid""=""pelcro_subid""))%>%"
"0","  mutate(row_number=row_number())%>%"
"0","  mutate(termnumber=ifelse(is.na(m),0,m)+row_number)%>%"
"0","  mutate(shiptocustomernumber=as.character(customeraccountid),"
"0","         pelcro_subid=subscriptionid,"
"0","         renewalordernumber=as.character(renewalordernumber),"
"0","         pubcode=publicationcode,"
"0","         adv_subid=adv_sub_id,"
"0","         startissuedate=start_date,"
"0","         expirationissuedate=expire_date,"
"0","         ordernumber=as.character(ordernumber)"
"0","         )%>%"
"0","  ungroup()%>%"
"0","  select(shiptocustomernumber,original_adv_cust_value,ordernumber,orderdate,brand,pubcode,adv_subid,pelcro_subid,termnumber,isautorenew,startissuedate,expirationissuedate,rate,termlength,renewalordernumber,renewalrate,renewalstartdate,donortype)"
