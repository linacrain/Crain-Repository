---
title: "AN Price Increase Analysis"
author: "Andrew Lin"
date: "2024-06-27"
output: 
  html_document:
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: true
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(ggplot2)
library(cmdstanr)
library(rstan)
library(tidybayes)
library(brms)
library(tidyverse)
library(DBI)
library(RPostgres)
library("readr") 
library(kableExtra)
library(knitr)
CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234

prod <- dbConnect(RPostgres::Postgres(),  
               host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
               port = 5439,
               user = 'aspireuser',
               password = 'Aspirecrainredshift1',
               dbname = 'prod',
               sslmode='require')

an_query<-dbGetQuery(prod, statement = read_file('AN_Individual_query.sql'))
an_price_increase_adobe<-read.csv("an_price_increase_adobe.csv")

repair_stanfit_names <- function(x) {
  stopifnot(is.stanfit(x))
  for (i in seq_along(x@sim$samples)) {
    names(x@sim$samples[[i]]) <- x@sim$fnames_oi
  }
  x
}
```

#Introduction

On 12/15/2023, AN set up another price increase that upped the rates for three product groups: Basic Digital Annual, Basic digital Monthly, and Premium Annual. 

#Annual Renewals
```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(an_query%>%
  filter(donortype=="I")%>%
  filter(expirationissuedate>=as.Date("01-08-2024",format="%m-%d-%Y")&orderdate<=as.Date("12-15-2023",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  filter(termlength=="Annual")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,ordernumber,orderdate,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,isautorenew)%>%
  filter(rate<=199)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299)|renewalordernumber>0&renewalrate>=rate,paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_undetermined=n_distinct(ifelse(renewalordernumber==0&expirationissuedate>=today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churned=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),rate,NA),na.rm=TRUE),
            mean_termnumber_renewal_pi=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),termnumber,NA),na.rm=TRUE),
            renewal_revenue_pi=sum(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Basic Digital",249,
                                     ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Premium",299,NA)),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_revenue_pi+churn_loss)%>%
  mutate(Product=pubcode,
         `Auto Renew`=isautorenew,
         `Total Contracts`=n_distinct_contracts,
         `Total Renewals at Increased Rate`=n_distinct_renewals_pi,
         `Total Churned`=n_distinct_churned,
         `Total Undetermined` = n_distinct_undetermined)%>%
    ungroup()%>%
    select(Product,`Auto Renew`,`Total Contracts`,`Total Renewals at Increased Rate`,`Total Churned`,`Total Undetermined`))
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(an_query%>%
  filter(donortype=="I")%>%
  filter(expirationissuedate>=as.Date("01-08-2024",format="%m-%d-%Y")&orderdate<=as.Date("12-15-2023",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  filter(termlength=="Annual")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,ordernumber,orderdate,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,isautorenew)%>%
  filter(rate<=199)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299)|renewalordernumber>0&renewalrate>=rate,paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_undetermined=n_distinct(ifelse(renewalordernumber==0&expirationissuedate>=today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churned=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),rate,NA),na.rm=TRUE),
            mean_termnumber_renewal_pi=mean(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber==0&expirationissuedate<=today(),termnumber,NA),na.rm=TRUE),
            renewal_revenue_pi=sum(ifelse((renewalordernumber>0&pubcode=="Basic Digital"&renewalrate>=249)|(renewalordernumber>0&pubcode=="Premium"&renewalrate>=299),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Basic Digital",249,
                                     ifelse(renewalordernumber==0&expirationissuedate<=today()&pubcode=="Premium",299,NA)),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_revenue_pi+churn_loss)%>%
  mutate(Product=pubcode,
         `Auto Renew`=isautorenew,
         `Churn Rate`=paste(round(n_distinct_churned/n_distinct_contracts,2)*100,'%'),
         `Mean Termnumber Renewed` = mean_termnumber_renewal_pi,
         `Mean Termnumber Churned` = mean_termnumber_churn,
         `Renewal Revenue`=renewal_revenue_pi,
         `Churned Loss`=churn_loss,
         `Initial Renewal Revenue`=renewal_revenue_pi+churn_loss)%>%
    ungroup()%>%
    select(Product,`Auto Renew`,`Churn Rate`,`Mean Termnumber Renewed`,`Mean Termnumber Churned`,`Initial Renewal Revenue`))
```

For our Annual Renewals, we notice that the majority of churned renewals after the price increase date occur for users that are not on Auto-Renew. On average, Premium customers have longer tenure compared to Basic Digital customers. On average, older customers tend to renew compared to churned users. Overall revenue, based on the renewal rates of customers that accepted the price increase and the potential loss from churned users, shows that the price increase was large enough to offset potential losses from churned users.


#Monthly Renewals

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(an_query%>%
  filter(donortype=="I")%>%
  filter(termlength=="Monthly")%>%
  filter(orderdate<=as.Date("01/15/2024",format="%m/%d/%Y")&termnumber!=1&expirationissuedate>=as.Date("01/15/2024",format="%m/%d/%Y")|orderdate<=as.Date("12/15/2023",format="%m/%d/%Y")&expirationissuedate>=as.Date("01-15-2024",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital")%>%
  filter(expirationissuedate<=today()|(expirationissuedate>=today()&!is.na(renewalordernumber)))%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,pelcro_subid)%>%
  mutate(min_order=min(termnumber))%>%
  filter(termnumber==min_order)%>%
  filter(rate<=20)%>%
  group_by(shiptocustomernumber,ordernumber,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,termlength,isautorenew)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_renewals_no_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate<=rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churn=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            median_rate_renewal_price_increase=median(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            median_rate_churn_price_increase=median(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            mean_termnumber_renewal=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber>0,NA,termnumber),na.rm=TRUE),
            renewal_pi_revenue=sum(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<today(),25,NA),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_pi_revenue+churn_loss)%>%
    mutate(Product=pubcode,
         `Auto Renew`=isautorenew,
         `Total Contracts`=n_distinct_contracts,
         `Total Renewals at Increased Rate`=n_distinct_renewals_pi,
         `Total Renewals no Price Increase`=n_distinct_renewals_no_pi,
         `Total Churned`=n_distinct_churn)%>%
    ungroup()%>%
    select(Product,`Auto Renew`,`Total Contracts`,`Total Renewals at Increased Rate`,`Total Churned`,`Total Renewals no Price Increase`))
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(an_query%>%
  filter(donortype=="I")%>%
  filter(termlength=="Monthly")%>%
  filter(orderdate<=as.Date("01/15/2024",format="%m/%d/%Y")&termnumber!=1&expirationissuedate>=as.Date("01/15/2024",format="%m/%d/%Y")|orderdate<=as.Date("12/15/2023",format="%m/%d/%Y")&expirationissuedate>=as.Date("01-15-2024",format="%m-%d-%Y"))%>%
  filter(pubcode=="Basic Digital")%>%
  filter(expirationissuedate<=today()|(expirationissuedate>=today()&!is.na(renewalordernumber)))%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,pelcro_subid)%>%
  mutate(min_order=min(termnumber))%>%
  filter(termnumber==min_order)%>%
  filter(rate<=20)%>%
  group_by(shiptocustomernumber,ordernumber,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,termlength,isautorenew)%>%
  summarise(n_distinct_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)),
            n_distinct_renewals_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_renewals_no_pi=n_distinct(ifelse((renewalordernumber>0&renewalrate<=rate),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            n_distinct_churn=n_distinct(ifelse(renewalordernumber==0&expirationissuedate<today(),paste(shiptocustomernumber,ordernumber,pelcro_subid),NA),na.rm=TRUE),
            mean_rate_renewal_price_increase=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            mean_rate_churn_price_increase=mean(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            median_rate_renewal_price_increase=median(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),rate,NA),na.rm=TRUE),
            median_rate_churn_price_increase=median(ifelse(renewalordernumber>0,NA,rate),na.rm=TRUE),
            mean_termnumber_renewal=mean(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),termnumber,NA),na.rm=TRUE),
            mean_termnumber_churn=mean(ifelse(renewalordernumber>0,NA,termnumber),na.rm=TRUE),
            renewal_pi_revenue=sum(ifelse((renewalordernumber>0&renewalrate>=25)|(renewalordernumber>0&renewalrate>rate),as.numeric(renewalrate),NA),na.rm=TRUE),
            churn_loss=-1*sum(ifelse(renewalordernumber==0&expirationissuedate<today(),25,NA),na.rm=TRUE),
            total_renewal_revenue_post_price_increase=renewal_pi_revenue+churn_loss)%>%
    mutate(Product=pubcode,
         `Auto Renew`=isautorenew,
         `Churn Rate`=paste(round(n_distinct_churn/n_distinct_contracts,2)*100,'%'),
         `Mean Termnumber Renewed` = mean_termnumber_renewal,
         `Mean Termnumber Churned` = mean_termnumber_churn,
         `Renewal Revenue (PI)`=renewal_pi_revenue,
         `Churned Loss`=churn_loss,
         `Initial Renewal Revenue`=renewal_pi_revenue+churn_loss)%>%
    ungroup()%>%
     select(Product,`Auto Renew`,`Churn Rate`,`Mean Termnumber Renewed`,`Mean Termnumber Churned`,`Churned Loss`,`Initial Renewal Revenue`))
```
For Monthly users, we are focusing on the inital renewal around the price increase. That is, the values represented above reflect the counts and rates for the earliest applicable monthly term. Similar to Annual users, we find that customers with auto-renew off have higher churn rates. The average tenure for a price-increase renewing individual is normally higher than that of a churned user. 

#New Orders

We'll first look at overall conversion rates between the two time periods. We are pulling customers who were able to navigate to the the subscription page during their visit to ensure the purchase reflects a recognized new price. 


```{r,echo=FALSE,message=FALSE,warning=FALSE}
sub_page_conv_rate<-an_price_increase_adobe%>%
  mutate(category=ifelse(date<as.Date('12/15/2023',format="%m/%d/%Y"),"pre_2nd_price_increase","post_2nd_price_increase"))%>%
  group_by(category)%>%
  summarise(total_unique_visitors=sum(unique_visitors),
            total_paid_orders=sum(new_paid_orders))%>%
  mutate(subscription_landing_page_conv_rate=total_paid_orders/total_unique_visitors)%>%
  mutate(category=as.factor(category))

knitr::kable(sub_page_conv_rate%>%
               mutate(`Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"),
                      `Unique Visitors`=total_unique_visitors,
                      `New Paid Orders`=total_paid_orders,
                      `Conversion Rate`=paste(round(subscription_landing_page_conv_rate,2)*100,'%',sep=''))%>%
               select(`Category`,`Unique Visitors`,`New Paid Orders`,`Conversion Rate`))

sub_page_conv_rate
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
sub_page_conv_rate_beta_binomial<-readRDS('sub_page_conv_rate_beta_binomial.rds')

sub_page_conv_rate_beta_binomial%>% 
  tidybayes::epred_draws(newdata = sub_page_conv_rate)%>%
  mutate(.epred_prop = .epred / total_unique_visitors) %>% 
  mutate(`Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"))%>%
  ggplot(aes(x = .epred_prop, y = Category, fill = category))+stat_halfeye()+theme_minimal()+labs(x="Proportion of Visitors who convert during a visit with Sub Page",y=NULL)+guides(fill="none")+scale_x_continuous(labels = label_percent())
```
```{r,echo=FALSE,message=FALSE,warning=FALSE}
sub_page_conv_rate_beta_binomial%>% 
  epred_draws(newdata = sub_page_conv_rate) %>% 
  mutate(.epred_prop = .epred / total_unique_visitors) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  ggplot(aes(x = .epred_prop)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent(), expand = c(0, 0.015)) +
  guides(fill = "none") +
  labs(x = "Percentage Point Diff in Proportions (Conversion Rates)",
       y = NULL) +
  theme_minimal()
```

Because the 95% credible interval for the percentage point difference in proportions between Initial and Secondary Price Increase contains 0, we cannot say with any certainty that there was a difference in conversion rates before or after the second price increase.

Let's instead split new orders by product type.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
pre_table<-an_query%>%
  filter(donortype=="I")%>%
  filter(orderdate<as.Date("12-15-2023",format="%m-%d-%Y"))%>%
  filter(orderdate>=as.Date("05-01-2023",format='%m-%d-%Y'))%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  filter(termnumber==1)%>%
  group_by(shiptocustomernumber,ordernumber,orderdate,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,isautorenew)%>%
  filter(rate==199|rate==20)%>%
  group_by(pubcode,termlength)%>%
  summarise(n_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)))%>%
  ungroup()%>%
  mutate(total_contracts=sum(n_contracts))%>%
  mutate(prop=round(n_contracts/total_contracts,2))%>%
  mutate(category="pre_2nd_price_increase")


post_table<-an_query%>%
  filter(donortype=="I")%>%
  filter(orderdate>=as.Date("12/15/2023",format="%m/%d/%Y")&termnumber==1)%>%
  filter(pubcode=="Basic Digital"|pubcode=="Premium")%>%
  mutate(pubcode=ifelse(pubcode=="AN3","Digital All Access",pubcode))%>%
  mutate(termnumber=as.numeric(termnumber))%>%
  group_by(shiptocustomernumber,ordernumber,pelcro_subid,isautorenew,pubcode,termnumber,termlength,rate,startissuedate,expirationissuedate)%>%
  summarise(renewalrate=max(renewalrate),
            renewalordernumber=n_distinct(renewalordernumber,na.rm=TRUE))%>%
  ungroup()%>%
  group_by(pubcode,isautorenew)%>%
  filter(rate==249|rate==25|rate==299)%>%
  group_by(pubcode,termlength)%>%
  summarise(n_contracts=n_distinct(paste(shiptocustomernumber,ordernumber,pelcro_subid)))%>%
  ungroup()%>%
  mutate(total_contracts=sum(n_contracts))%>%
  mutate(prop=round(n_contracts/total_contracts,2))%>%
  mutate(category="post_2nd_price_increase")

full_table<-union(pre_table,post_table)
premium_annual<-full_table%>%
  filter(pubcode=="Premium"&termlength=="Annual")%>%
  mutate(category=as.factor(category))

knitr::kable(full_table%>%
               mutate(`Product`=pubcode,
                      `Term Length`=termlength,
                      `New Orders`=n_contracts,
                      `Total New Orders`=total_contracts,
                      `Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"),
                      `Proportion of Orders`=paste(prop*100,'%',sep=''))%>%
               mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
               arrange(`Category`)%>%
                        select(`Category`,`Product`,`Term Length`,`New Orders`,`Total New Orders`,`Proportion of Orders`)%>%
               filter(Product!="Premium"|`Term Length`!="Monthly"))
```

It seems that the share of Premium Annual orders drops post-2nd price increase. Between 5/1/2023 and 12/14/2023, both Basic Digital and Premium Annual subscriptions were at \$199. After 12/15/2023, Basic Digital increased to \$249 while Premium increased to \$299. Did this price increase cause a drop in Premium Annual subscriptions?

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(full_table%>%
               mutate(`Product`=pubcode,
                      `Term Length`=termlength,
                      `New Orders`=n_contracts,
                      `Total New Orders`=total_contracts,
                      `Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"),
                      `Proportion of Orders`=paste(prop*100,'%',sep=''))%>%
               mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
               arrange(`Category`)%>%
                        select(`Category`,`Product`,`Term Length`,`New Orders`,`Total New Orders`,`Proportion of Orders`)%>%
               filter(Product=="Premium"&`Term Length`=="Annual"))
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
premium_annual_beta_binomial <- readRDS('premium_annual_beta_binomial.rds')


premium_annual_beta_binomial%>% 
  tidybayes::epred_draws(newdata = premium_annual)%>%
  mutate(`Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"))%>%
  mutate(.epred_prop = .epred / total_contracts) %>% 
  mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
  ggplot(aes(x = .epred_prop, y = forcats::fct_inorder(Category), fill = Category))+stat_halfeye()+theme_minimal()+labs(x="Proportion of New Users who subscribe at Premium Annual",y=NULL)+guides(fill="none")+scale_x_continuous(labels = label_percent())
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
premium_annual_beta_binomial%>% 
  epred_draws(newdata = premium_annual) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  ggplot(aes(x = .epred_prop)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent(), expand = c(0, 0.015)) +
  guides(fill = "none") +
  labs(x = "Percentage Point Diff in Proportions (Premium Annual)",
       y = NULL) +
  theme_minimal()
```

Users are less likely to purchase Premium Annual subscriptions after the second price increase. On average, Premium Annual orders before the second price increase encompassed 23% (between 22% - 25%) of total new orders while Premium Annual orders after the second price increase encompassed 16% (between 15% - 17%). There is a 95% posterior probability that the difference between these two proportions is between 5.7% and 8.9% with a median of 7.3%. This difference is substantial and there is a 100% chance the difference is not zero

```{r,echo=FALSE,include=FALSE,message=FALSE,warning=FALSE}
premium_annual_beta_binomial%>% 
  epred_draws(newdata = premium_annual) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  mutate(`95q`=quantile(.epred_prop,0.95),
         `5q`=quantile(.epred_prop,0.05),
         m=median(.epred_prop))
```

So if users are not purchasing Premium Annual subscriptions, where are they going? It seems that Basic Digital Annual subscriptions are improving post second price increase...


```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(full_table%>%
               mutate(`Product`=pubcode,
                      `Term Length`=termlength,
                      `New Orders`=n_contracts,
                      `Total New Orders`=total_contracts,
                      `Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"),
                      `Proportion of Orders`=paste(prop*100,'%',sep=''))%>%
               mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
               arrange(`Category`)%>%
                        select(`Category`,`Product`,`Term Length`,`New Orders`,`Total New Orders`,`Proportion of Orders`)%>%
               filter(Product=="Basic Digital"&`Term Length`=="Annual"))
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
basic_digital_annual<-full_table%>%
  filter(pubcode=="Basic Digital"&termlength=="Annual")%>%
  mutate(category=as.factor(category))

basic_digital_beta_binomial <- readRDS('basic_digital_beta_binomial.rds')
  
basic_digital_beta_binomial%>% 
  tidybayes::epred_draws(newdata = basic_digital_annual)%>%
  mutate(`Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"))%>%
  mutate(.epred_prop = .epred / total_contracts) %>% 
  mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
  ggplot(aes(x = .epred_prop, y = forcats::fct_inorder(Category), fill = Category))+stat_halfeye()+theme_minimal()+labs(x="Proportion of New Users who subscribe at Basic Digital Annual",y=NULL)+guides(fill="none")+scale_x_continuous(labels = label_percent())
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}
basic_digital_beta_binomial%>% 
  epred_draws(newdata = basic_digital_annual) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  ggplot(aes(x = .epred_prop)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent(), expand = c(0, 0.015)) +
  guides(fill = "none") +
  labs(x = "Percentage Point Diff in Proportions (Basic Digital Annual)",
       y = NULL) +
  theme_minimal()
```
Users are more likely to purchase Basic Digital Annual subscriptions after the second price increase. On average, Basic Digital Annual new orders before the second price increase encompassed 33% (between 31% - 35%) of total new orders while Basic Digital Annual orders after the second price increase encompassed 42% (between 40% - 43%). There is a 95% posterior probability that the difference between these two proportions is between -10.8% and -6.8% with a median of -8.8%.
This difference is substantial and there is a 100% chance the difference is not zero.


What about Monthly Orders?

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::kable(full_table%>%
               mutate(`Product`=pubcode,
                      `Term Length`=termlength,
                      `New Orders`=n_contracts,
                      `Total New Orders`=total_contracts,
                      `Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"),
                      `Proportion of Orders`=paste(prop*100,'%',sep=''))%>%
               mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
               arrange(`Category`)%>%
                        select(`Category`,`Product`,`Term Length`,`New Orders`,`Total New Orders`,`Proportion of Orders`)%>%
               filter(Product=="Basic Digital"&`Term Length`=="Monthly"))
```


```{r,echo=FALSE,message=FALSE,warning=FALSE}
basic_digital_monthly<-full_table%>%
  filter(pubcode=="Basic Digital"&termlength=="Monthly")%>%
  mutate(category=as.factor(category))

basic_digital_monthly_beta_binomial <- readRDS('basic_digital_monthly_beta_binomial.rds')

```


```{r}

basic_digital_monthly_beta_binomial%>% 
  tidybayes::epred_draws(newdata = basic_digital_monthly)%>%
  mutate(`Category`=ifelse(str_detect(category,"pre_2nd"),"Initial Price Increase (5/1/2023 - 12/14/2023)",
                                        "Second Price Increase (12/15/2023 Onwards)"))%>%
  mutate(.epred_prop = .epred / total_contracts) %>% 
  mutate(`Category`=factor(`Category`,levels=c("Second Price Increase (12/15/2023 Onwards)","Initial Price Increase (5/1/2023 - 12/14/2023)")))%>%
  ggplot(aes(x = .epred_prop, y = forcats::fct_inorder(Category), fill = Category))+stat_halfeye()+theme_minimal()+labs(x="Proportion of New Users who subscribe at Basic Digital Monthly",y=NULL)+guides(fill="none")+scale_x_continuous(labels = label_percent())
```
```{r}
basic_digital_monthly_beta_binomial%>% 
  epred_draws(newdata = basic_digital_monthly) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  ggplot(aes(x = .epred_prop)) +
  stat_halfeye() +
  scale_x_continuous(labels = label_percent(), expand = c(0, 0.015)) +
  guides(fill = "none") +
  labs(x = "Percentage Point Diff in Proportions (Basic Digital Monthly)",
       y = NULL) +
  theme_minimal()
```

There is a 95% posterior probability that the percentage point difference between post-price increase and pre-price increase is between -0.53% and 3.5% with a median of 1.5%. Because the 95% credible interval contains 0, we can there is not enough evidence to say there is a difference between monthly basic digital order shares before and after the second price increase.


```{r,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
basic_digital_monthly_beta_binomial%>% 
  epred_draws(newdata = basic_digital_monthly) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  mutate(`95q`=quantile(.epred_prop,0.95),
         `5q`=quantile(.epred_prop,0.05),
         m=median(.epred_prop))
```


Ultimately, it seems that with the new price increase, new paid orders as a whole are operating with a similar conversion rate and increasing ARPU. However, with the raising of the prices to \$299 for Premium Annual and \$249 for Basic Digital from a flat rate of \$199, it appears that users are less inclined to purchase Premium Annual subscriptions when they can opt for the cheaper Basic Digital subscription.

```{r,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
basic_digital_beta_binomial%>% 
  epred_draws(newdata = basic_digital_annual) %>% 
  mutate(.epred_prop = .epred / total_contracts) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category))%>%
  compare_levels(.epred_prop, by = category,
                 comparison = "pairwise")%>%
  mutate(`95q`=quantile(.epred_prop,0.95),
         `5q`=quantile(.epred_prop,0.05),
         m=median(.epred_prop))
```


























