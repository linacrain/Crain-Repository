library(tidyverse)
library(readr)
library(DBI)
library(RPostgres)
library(tidyverse)
library(DBI)
library(RPostgres)
library(ggplot2)
library(cmdstanr)
library(rstan)
library(StanHeaders)
library(rstantools)
library(tidybayes)
library(brms)
library(scales)
library(zoo)
library(ggpubr)
library(marginaleffects)
library(data.table)
CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234
prod <- dbConnect(RPostgres::Postgres(),
host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
port = 5439,
user = 'aspireuser',
password = 'Aspirecrainredshift1',
dbname = 'prod',
sslmode='require')
an_pelcro<-dbGetQuery(prod,statement=read_file("pelcro_new_an.sql"))
an_adv<-dbGetQuery(prod,statement=read_file("an_query.sql"))
last_touch_info<-AN_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
filter(nrow==order_row_number)%>%
select(uid_max,Purchase.IDs,Referrer.Type)%>%
distinct()
AN_NBA_rolled_up<-read.csv("AN_data_rolled_up_orders.csv")
AN_aggregated<-AN_NBA_rolled_up
last_touch_info<-AN_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
filter(nrow==order_row_number)%>%
select(uid_max,Purchase.IDs,Referrer.Type)%>%
distinct()
last_touch_info_2<-AN_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
filter(nrow==order_row_number)%>%
select(uid_max,Date)%>%
mutate(uid_max=as.double(uid_max))%>%
filter(!is.na(uid_max))%>%
distinct()
order_info_an<-an_adv%>%
filter(owningoffice=="AN")%>%
filter(startissuedate>=as.Date("2023-01-01")|is.na(startissuedate))%>%
select(ordernumber,publicationcode,termlength)%>%
distinct()%>%
group_by(ordernumber)%>%
mutate(n=n_distinct(publicationcode))
pelcro_info_an<-an_pelcro%>%
select(shiptocustomernumber,invoiceid,subscriptionid,termlength,pubcode,orderdate)%>%
distinct()%>%
mutate(shiptocustomernumber=str_replace_all(shiptocustomernumber,"[^0-9.-]",""))%>%
mutate(shiptocustomernumber=as.double(shiptocustomernumber))
AN_cleaned_ADV_rows<-AN_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
group_by(Date,uid_max,Mobile.Device.Type,Referrer.Type)%>%
mutate(Visitor.Access..v61...evar61.=ifelse(Visitor.Access..v61...evar61.=="","anonymous",Visitor.Access..v61...evar61.))%>%
mutate(visitor_access_level=ifelse(Visitor.Access..v61...evar61.=="reg"|Visitor.Access..v61...evar61.=="reg_mexico"|Visitor.Access..v61...evar61.=="registered",1,
ifelse(Visitor.Access..v61...evar61.=="anonymous",0,2)))%>%
group_by(uid_max,Date,Referrer.Type)%>%
summarise(visitor_access_level=max(visitor_access_level,na.rm=TRUE),
n_visits=n_distinct(paste(Visitor_ID,Visit.Number)),
did_order=max(Orders),
)%>%
group_by(uid_max)%>%
arrange(Date,.by_group=TRUE)%>%
group_by(uid_max,Date)%>%
spread(Referrer.Type,n_visits)%>%
group_by(uid_max,Date)%>%
summarise(visitor_access_level=max(visitor_access_level),
did_order=max(did_order),
`other.web.sites`=sum(`other web sites`,na.rm=TRUE),
`search.engines`=sum(`search engines`,na.rm=TRUE),
`social.networks`=sum(`social networks`,na.rm=TRUE),
`typed_bookmarked`=sum(`typed/bookmarked`,na.rm=TRUE))%>%
ungroup()%>%
group_by(uid_max)%>%
summarise(visitor_access_level=max(visitor_access_level),
total_days=n_distinct(Date),
`other.web.sites`=sum(`other.web.sites`,na.rm=TRUE),
`search.engines`=sum(`search.engines`,na.rm=TRUE),
`social.networks`=sum(`social.networks`,na.rm=TRUE),
`typed_bookmarked`=sum(`typed_bookmarked`,na.rm=TRUE))%>%
left_join(last_touch_info,by=c("uid_max"="uid_max"))%>%
left_join(order_info_an,by=c("Purchase.IDs"="ordernumber"))%>%
filter(!is.na(publicationcode))%>%
mutate(product=ifelse((publicationcode=="AN4"&n==2)|(publicationcode=="AN3"&n==2),"All Access",
ifelse(publicationcode=="AN2"&n==1,"Digital Only",
ifelse(publicationcode=="AN1","Premium (Digital + Print)","Other"))))%>%
mutate(product_level=ifelse(product=="All Access",4,
ifelse(product=="Premium (Digital + Print)",3,
ifelse(product=="Digital Only",2,1))))%>%
group_by(uid_max,visitor_access_level,total_days,other.web.sites,search.engines,social.networks,typed_bookmarked,Purchase.IDs,Referrer.Type,termlength)%>%
summarise(p=max(product_level))%>%
mutate(product=ifelse(p==2,"Digital Only",
ifelse(p==3,"Premium (Digital + Print)","All Access")))%>%
mutate(product=ifelse(product=="Digital Only"&termlength<=4,"Digital Only - Monthly",
ifelse(product=="Digital Only"&termlength>4,"Digital Only - Annual",product)))%>%
mutate(last_touch_referrer=Referrer.Type)%>%
ungroup()%>%
select(-c(p,termlength,Referrer.Type))%>%
distinct()
AN_cleaned_pelcro_rows<-AN_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
group_by(Date,uid_max,Mobile.Device.Type,Referrer.Type)%>%
mutate(Visitor.Access..v61...evar61.=ifelse(Visitor.Access..v61...evar61.=="","anonymous",Visitor.Access..v61...evar61.))%>%
mutate(visitor_access_level=ifelse(Visitor.Access..v61...evar61.=="reg"|Visitor.Access..v61...evar61.=="reg_mexico"|Visitor.Access..v61...evar61.=="registered",1,
ifelse(Visitor.Access..v61...evar61.=="anonymous",0,2)))%>%
group_by(uid_max,Date,Referrer.Type)%>%
summarise(visitor_access_level=max(visitor_access_level,na.rm=TRUE),
n_visits=n_distinct(paste(Visitor_ID,Visit.Number)),
did_order=max(Orders),
)%>%
group_by(uid_max)%>%
arrange(Date,.by_group=TRUE)%>%
group_by(uid_max,Date)%>%
spread(Referrer.Type,n_visits)%>%
group_by(uid_max,Date)%>%
summarise(visitor_access_level=max(visitor_access_level),
did_order=max(did_order),
`other.web.sites`=sum(`other web sites`,na.rm=TRUE),
`search.engines`=sum(`search engines`,na.rm=TRUE),
`social.networks`=sum(`social networks`,na.rm=TRUE),
`typed_bookmarked`=sum(`typed/bookmarked`,na.rm=TRUE))%>%
ungroup()%>%
group_by(uid_max)%>%
summarise(visitor_access_level=max(visitor_access_level),
total_days=n_distinct(Date),
`other.web.sites`=sum(`other.web.sites`,na.rm=TRUE),
`search.engines`=sum(`search.engines`,na.rm=TRUE),
`social.networks`=sum(`social.networks`,na.rm=TRUE),
`typed_bookmarked`=sum(`typed_bookmarked`,na.rm=TRUE))%>%
left_join(last_touch_info,by=c("uid_max"="uid_max"))%>%
left_join(order_info_an,by=c("Purchase.IDs"="ordernumber"))%>%
filter(is.na(publicationcode))%>%
mutate(uid_max=as.double(uid_max))%>%
left_join(pelcro_info_an,by=c("uid_max"="shiptocustomernumber"))%>%
left_join(last_touch_info_2,by=c("uid_max"="uid_max"))%>%
mutate(orderdate=as.Date(orderdate))%>%
filter(orderdate==Date)%>%
ungroup()%>%
mutate(publevel=ifelse(pubcode=="Basic Digital",1,
ifelse(pubcode=="Premium",2,3)))%>%
group_by(uid_max)%>%
mutate(mpublevel=max(publevel))%>%
filter(publevel==mpublevel)%>%
mutate(product=ifelse(pubcode=="Premium","Premium (Digital + Print)",
ifelse(pubcode=="All Access","All Access",
ifelse(pubcode=="Basic Digital"&termlength.y=="Annual","Digital Only - Annual","Digital Only - Monthly"))))%>%
mutate(last_touch_referrer=Referrer.Type)%>%
select(-c(Referrer.Type,publicationcode,termlength.x,n,invoiceid,subscriptionid,termlength.y,pubcode,orderdate,Date,publevel,mpublevel))%>%
distinct()
full_an_set<-rbind(AN_cleaned_ADV_rows,AN_cleaned_pelcro_rows)
full_an_set<-full_an_set%>%
mutate(product=as.factor(product),
last_touch_referrer=as.factor(last_touch_referrer),
visitor_access_level=as.factor(ifelse(visitor_access_level==2,"subscribed",
ifelse(visitor_access_level==1,"reg","anonymous"))))
full_an_set%>%
group_by(product)%>%
summarise(n=n_distinct(uid_max))
write.csv(full_an_set,"full_an_set.csv")
basic_fit<-readRDS(an_basic_fit.rds)
basic_fit<-readRDS("an_basic_fit.rds")
post_data<-full_an_set%>%
add_fitted_draws(basic_fit,n=1000,re_formula=NA)
post_data%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(visitor_access_level,total_day_category,.category)%>%
summarise(mean_value=round(mean(.value)*100,1))%>%
ungroup()%>%
ggplot(aes(y=mean_value,x=total_day_category,color=.category,group=.category))+geom_point(alpha=0.4)+geom_line()+
facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.5),panel.background = element_rect(fill = "white", colour = "grey50"))+geom_text(aes(label=paste(mean_value,"%",sep="")),position=position_dodge(width=1),size=3,vjust=-0.5)+labs(y="Proability of Purchasing",x="Total Days Visited",color="Product Outcome")
post_data%>%
group_by(.row,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=channel_level,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Channel Segment",color="Product Purchased")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=channel_level,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Channel Segment",color="Product Purchased")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
