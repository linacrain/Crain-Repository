group_by(uid_max,Purchase.IDs)%>%
mutate(product=ifelse(n==2,"All Access",
ifelse(publicationcode=="AA"|publicationcode=="AAZ","Digital Only",
ifelse(publicationcode=="AAD","All Access","dingdong"))))%>%
mutate(product=paste(product,termlength,sep="_"))%>%
mutate(last_touch_referrer=Referrer.Type)%>%
select(-c(publicationcode,n,termlength,Referrer.Type))%>%
distinct()%>%
mutate(visitor_access_level=ifelse(visitor_access_level==2,"subscribed",
ifelse(visitor_access_level==1,"Reg","anonymous")))%>%
mutate(visitor_access_level=as.factor(visitor_access_level),
product=as.factor(product),
last_touch_referrer=as.factor(last_touch_referrer))
gc()
aa_model_2_int_brms <- brm(
bf(product~visitor_access_level*total_days*last_touch_referrer+missing+other.web.sites+search.engines+social.networks+typed_bookmarked),
data = full_aa_set,
family = "categorical",
chains = CHAINS, warmup = WARMUP, iter = ITER, seed = BAYES_SEED,
cores=4,
refresh = 0
)
saveRDS(aa_model_2_int_brms,"aa_model_int_brms.rds")
summary(aa_model_2_int_brms)
conditional_effects(aa_model_2_int_brms,categorical=TRUE)
pred<-predictions(aa_model_2_int_brms)
draws <- posterior_draws(pred)
draws
plot(aa_model_2_int_brms)
post_data
post_data<-full_mh_set_no_print%>%
add_fitted_draws(mh_model_2_int_brms,n=1000,re_formula=NA)
post_data<-full_aa_set%>%
add_fitted_draws(aa_model_2_int_brms,n=1000,re_formula=NA)
post_data
post_data%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(visitor_access_level,total_day_category,.category)%>%
summarise(mean_value=round(mean(.value)*100,1))%>%
ungroup()%>%
ggplot(aes(y=mean_value,x=total_day_category,color=.category,group=.category))+geom_point(alpha=0.4)+geom_line()+
facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.5),panel.background = element_rect(fill = "white", colour = "grey50"))+geom_text(aes(label=paste(mean_value,"%",sep="")),position=position_dodge(width=1),size=3,vjust=-0.5)+labs(y="Proability of Purchasing",x="Total Days Visited",color="Product Outcome")
post_data%>%
group_by(visitor_access_level,last_touch_referrer,.category)%>%
summarise(mean_value=round(mean(.value)*100,1))%>%
ungroup()%>%
ggplot(aes(y=mean_value,x=last_touch_referrer,fill=.category,group=.category))+geom_bar(stat="identity",position="dodge")+
facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="% of Purchasing",x="Last Touch Source",color="Product Outcome")
post_data%>%
group_by(.row,missing,other_web_sites,search_engines,social_networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_web_sites`=ifelse(last_touch_referrer=="other web sites",`other_web_sites`+1,`other_web_sites`),
`search_engines`=ifelse(last_touch_referrer=="search engines",`search_engines`+1,`search_engines`),
`social_networks`=ifelse(last_touch_referrer=="social networks",`social_networks`+1,`social_networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other_web_sites`>0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,'other_web_sites',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`>0&`social_networks`==0&`typed_bookmarked`==0,'search_engines',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`>0&`typed_bookmarked`==0,'social_networks',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(channel_level,.category,total_day_category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_grid(vars(channel_level),vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other_web_sites,search_engines,social_networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)
post_data
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed.bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_web_sites`=ifelse(last_touch_referrer=="other web sites",`other_web_sites`+1,`other_web_sites`),
`search_engines`=ifelse(last_touch_referrer=="search engines",`search_engines`+1,`search_engines`),
`social_networks`=ifelse(last_touch_referrer=="social networks",`social_networks`+1,`social_networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other_web_sites`>0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,'other_web_sites',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`>0&`social_networks`==0&`typed_bookmarked`==0,'search_engines',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`>0&`typed_bookmarked`==0,'social_networks',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(channel_level,.category,total_day_category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_grid(vars(channel_level),vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_web_sites`=ifelse(last_touch_referrer=="other web sites",`other_web_sites`+1,`other_web_sites`),
`search_engines`=ifelse(last_touch_referrer=="search engines",`search_engines`+1,`search_engines`),
`social_networks`=ifelse(last_touch_referrer=="social networks",`social_networks`+1,`social_networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other_web_sites`>0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`==0,'other_web_sites',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`>0&`social_networks`==0&`typed_bookmarked`==0,'search_engines',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`>0&`typed_bookmarked`==0,'social_networks',
ifelse(`missing`==0&`other_web_sites`==0&`search_engines`==0&`social_networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(channel_level,.category,total_day_category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_grid(vars(channel_level),vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(channel_level,.category,total_day_category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_grid(vars(channel_level),vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(channel_level,.category,total_day_category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_grid(vars(channel_level),vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
gather(referrer_source,visit_count,missing:typed_bookmarked)%>%
group_by(.row,.category,last_touch_referrer,visitor_access_level)%>%
summarise(m=mean(m),
n_distinct_channels=n_distinct(ifelse(visit_count>0,referrer_source,NA),na.rm=TRUE))%>%
ungroup()%>%
mutate(n_distinct_channels=as.character(n_distinct_channels))%>%
mutate(n_distinct_channels=as.factor(n_distinct_channels))%>%
group_by(.category,last_touch_referrer,visitor_access_level,n_distinct_channels)%>%
summarise(m=mean(m))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=n_distinct_channels,y=m,color=last_touch_referrer,group=last_touch_referrer))+geom_point(alpha=0.3)+geom_line(alpha=0.5)+facet_grid(vars(.category),vars(visitor_access_level),)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(x="# Distinct Channels",y="Avg. Expected Probability of ")
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
gather(referrer_source,visit_count,missing:typed_bookmarked)%>%
group_by(.row,.category,last_touch_referrer,visitor_access_level)%>%
summarise(m=mean(m),
n_distinct_channels=n_distinct(ifelse(visit_count>0,referrer_source,NA),na.rm=TRUE))%>%
ungroup()%>%
mutate(n_distinct_channels=as.character(n_distinct_channels))%>%
mutate(n_distinct_channels=as.factor(n_distinct_channels))%>%
group_by(.category,last_touch_referrer,visitor_access_level,n_distinct_channels)%>%
summarise(m=mean(m))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=n_distinct_channels,y=m,color=last_touch_referrer,group=last_touch_referrer))+geom_point(alpha=0.3)+geom_line(alpha=0.5)+facet_grid(vars(.category),vars(visitor_access_level),)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(x="# Distinct Channels",y="Avg. Expected Probability of ")
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
gather(referrer_source,visit_count,missing:typed_bookmarked)%>%
group_by(.row,.category,last_touch_referrer,visitor_access_level)%>%
summarise(m=mean(m),
n_distinct_channels=n_distinct(ifelse(visit_count>0,referrer_source,NA),na.rm=TRUE))%>%
ungroup()%>%
mutate(n_distinct_channels=as.character(n_distinct_channels))%>%
mutate(n_distinct_channels=as.factor(n_distinct_channels))%>%
group_by(.category,last_touch_referrer,visitor_access_level,n_distinct_channels)%>%
summarise(m=mean(m))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=n_distinct_channels,y=m,color=last_touch_referrer,group=last_touch_referrer))+geom_point(alpha=0.3)+geom_line(alpha=0.5)+facet_grid(vars(.category),vars(visitor_access_level),)+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(x="# Distinct Channels",y="Avg. Expected Probability of ")
gather(referrer_source,visit_number,missing:typed_bookmarked)%>%
group_by(.row)%>%
arrange(last_touch_referrer,.by_group=TRUE)
post_data%>%
mutate(total_day_category=ifelse(total_days==1,"One Day",
ifelse(total_days>1&total_days<=5,"2 - 5 Days","6 Days +")))%>%
mutate(total_day_category=factor(total_day_category,levels=c("One Day","2 - 5 Days","6 Days +")))%>%
group_by(visitor_access_level,total_day_category,.category)%>%
summarise(mean_value=round(mean(.value)*100,1))%>%
ungroup()%>%
ggplot(aes(y=mean_value,x=total_day_category,color=.category,group=.category))+geom_point(alpha=0.4)+geom_line()+
facet_wrap(~visitor_access_level)+theme(axis.text.x = element_text(angle = 90,vjust=-0.5),panel.background = element_rect(fill = "white", colour = "grey50"))+geom_text(aes(label=paste(mean_value,"%",sep="")),position=position_dodge(width=1),size=3,vjust=-0.5)+labs(y="Proability of Purchasing",x="Total Days Visited",color="Product Outcome")
library(tidyverse)
library(readr)
library(DBI)
library(RPostgres)
library(tidyverse)
library(DBI)
library(RPostgres)
library(ggplot2)
library(cmdstanr)
library(rstan)
library(StanHeaders)
library(rstantools)
library(tidybayes)
library(brms)
library(scales)
library(zoo)
library(ggpubr)
library(marginaleffects)
CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234
AA_NBA_rolled_up<-readRDS("AA_data_rolled_up_orders.csv")
AA_NBA_rolled_up<-read.csv("AA_data_rolled_up_orders.csv")
AA_aggregated<-AA_NBA_rolled_up
last_touch_info<-AA_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
filter(nrow==order_row_number)%>%
select(uid_max,Purchase.IDs,Referrer.Type)%>%
mutate(Referrer.Type=ifelse(is.na(Referrer.Type),"missing",Referrer.Type))%>%
distinct()
order_info<-aa_adv%>%
filter(owningoffice=="AA")%>%
filter(startissuedate>=as.Date("2023-01-01")|is.na(startissuedate))%>%
select(ordernumber,publicationcode,termlength)%>%
distinct()%>%
group_by(ordernumber)%>%
mutate(n=n_distinct(publicationcode))
order_info<-aa_adv%>%
filter(owningoffice=="AA")%>%
filter(startissuedate>=as.Date("2023-01-01")|is.na(startissuedate))%>%
select(ordernumber,publicationcode,termlength)%>%
distinct()%>%
group_by(ordernumber)%>%
mutate(n=n_distinct(publicationcode))
prod <- dbConnect(RPostgres::Postgres(),
host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
port = 5439,
user = 'aspireuser',
password = 'Aspirecrainredshift1',
dbname = 'prod',
sslmode='require')
aa_adv<-dbGetQuery(prod,statement=read_file("aa_query.sql"))
order_info<-aa_adv%>%
filter(owningoffice=="AA")%>%
filter(startissuedate>=as.Date("2023-01-01")|is.na(startissuedate))%>%
select(ordernumber,publicationcode,termlength)%>%
distinct()%>%
group_by(ordernumber)%>%
mutate(n=n_distinct(publicationcode))
write.csv(order_info,"aa_order_info_from_adv.csv")
full_aa_set<-AA_aggregated%>%
mutate(Date=as.Date(Date,format="%Y-%m-%d"))%>%
group_by(uid_max)%>%
arrange(Date,Visit.Number,Clicks.to.Page,.by_group=TRUE)%>%
group_by(Date,uid_max,Mobile.Device.Type,Referrer.Type)%>%
mutate(Visitor.Access..v61...evar61.=ifelse(Visitor.Access..v61...evar61.=="","anonymous",Visitor.Access..v61...evar61.))%>%
mutate(visitor_access_level=ifelse(Visitor.Access..v61...evar61.=="reg"|Visitor.Access..v61...evar61.=="reg_metered",1,
ifelse(Visitor.Access..v61...evar61.=="anonymous",0,2)))%>%
group_by(uid_max,Date,Referrer.Type)%>%
summarise(visitor_access_level=max(visitor_access_level,na.rm=TRUE),
n_visits=n_distinct(paste(Visitor_ID,Visit.Number)),
did_order=max(Orders),
)%>%
group_by(uid_max)%>%
arrange(Date,.by_group=TRUE)%>%
group_by(uid_max,Date)%>%
mutate(Referrer.Type=ifelse(is.na(Referrer.Type)|Referrer.Type=="","missing",Referrer.Type))%>%
spread(Referrer.Type,n_visits)%>%
group_by(uid_max,Date)%>%
summarise(visitor_access_level=max(visitor_access_level),
did_order=max(did_order),
missing=sum(missing,na.rm=TRUE),
`other web sites`=sum(`other web sites`,na.rm=TRUE),
`search engines`=sum(`search engines`,na.rm=TRUE),
`social networks`=sum(`social networks`,na.rm=TRUE),
`typed/bookmarked`=sum(`typed/bookmarked`,na.rm=TRUE))%>%
ungroup()%>%
group_by(uid_max)%>%
summarise(visitor_access_level=max(visitor_access_level),
total_days=n_distinct(Date),
missing=sum(missing,na.rm=TRUE),
`other.web.sites`=sum(`other web sites`,na.rm=TRUE),
`search.engines`=sum(`search engines`,na.rm=TRUE),
`social.networks`=sum(`social networks`,na.rm=TRUE),
`typed_bookmarked`=sum(`typed/bookmarked`,na.rm=TRUE))%>%
left_join(last_touch_info,by=c("uid_max"="uid_max"))%>%
mutate(Referrer.Type=ifelse(Referrer.Type==""|is.na(Referrer.Type),"missing",Referrer.Type))%>%
filter(!(Referrer.Type=="missing"&social.networks==0&typed_bookmarked==0&search.engines==0&other.web.sites==0))%>%
left_join(order_info,by=c("Purchase.IDs"="ordernumber"))%>%
mutate(termlength=ifelse(termlength<=4,"monthly","annual"))%>%
filter(!is.na(publicationcode))%>%
group_by(uid_max,Purchase.IDs)%>%
mutate(product=ifelse(n==2,"All Access",
ifelse(publicationcode=="AA"|publicationcode=="AAZ","Digital Only",
ifelse(publicationcode=="AAD","All Access","dingdong"))))%>%
mutate(product=paste(product,termlength,sep="_"))%>%
mutate(last_touch_referrer=Referrer.Type)%>%
select(-c(publicationcode,n,termlength,Referrer.Type))%>%
distinct()%>%
mutate(visitor_access_level=ifelse(visitor_access_level==2,"subscribed",
ifelse(visitor_access_level==1,"Reg","anonymous")))%>%
mutate(visitor_access_level=as.factor(visitor_access_level),
product=as.factor(product),
last_touch_referrer=as.factor(last_touch_referrer))
aa_model_2_int_brms<-readRDS("aa_model_int_brms.rds")
post_data<-full_aa_set%>%
add_fitted_draws(aa_model_2_int_brms,n=1000,re_formula=NA)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=total_day_category,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=channel_level,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=channel_level,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Total Days",color="Product Purchased",title="Likelihood to Order (Anonymous, Direct and Multi-Channel)")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
post_data%>%
group_by(.row,missing,other.web.sites,search.engines,social.networks,typed_bookmarked,last_touch_referrer,.category,visitor_access_level,total_days)%>%
summarise(m=mean(.value))%>%
ungroup()%>%
mutate(missing=ifelse(last_touch_referrer=="missing",missing+1,missing),
`other_.web_sites`=ifelse(last_touch_referrer=="other web sites",`other.web.sites`+1,`other.web.sites`),
`search.engines`=ifelse(last_touch_referrer=="search engines",`search.engines`+1,`search.engines`),
`social.networks`=ifelse(last_touch_referrer=="social networks",`social.networks`+1,`social.networks`),
`typed_bookmarked`=ifelse(last_touch_referrer=="typed/bookmarked",`typed_bookmarked`+1,`typed_bookmarked`))%>%
mutate(channel_level=ifelse(`missing`>0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,"missing",
ifelse(`missing`==0&`other.web.sites`>0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`==0,'other.web.sites',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`>0&`social.networks`==0&`typed_bookmarked`==0,'search.engines',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`>0&`typed_bookmarked`==0,'social.networks',
ifelse(`missing`==0&`other.web.sites`==0&`search.engines`==0&`social.networks`==0&`typed_bookmarked`>0,'typed_bookmarked','Multi-channel'))))))%>%
group_by(channel_level,.category,visitor_access_level)%>%
summarise(m=mean(m))%>%
ungroup()%>%
mutate(channel_level=ifelse(channel_level=="other_web_sites","other site",
ifelse(channel_level=="social_networks","social",
ifelse(channel_level=="search_engines","search",
ifelse(channel_level=="typed_bookmarked","direct",channel_level)))))%>%
mutate(m=round(m*100,1))%>%
ggplot(aes(x=channel_level,y=m,color=.category,group=.category))+geom_point()+geom_line()+facet_wrap(vars(visitor_access_level))+theme(axis.text.x = element_text(angle = 90,vjust=-0.2),panel.background = element_rect(fill = "white", colour = "grey50"))+labs(y="Likelihood to Order",x="Channel Segment",color="Product Purchased")+geom_text(aes(label=paste(m,"%",sep="")),position=position_dodge(width=0.1),size=3,vjust=-0.5)
