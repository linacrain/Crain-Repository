quantity=plan_interval_count,
addressid=shipping_address_id,
brand=businessunitcode,
productid=product_id.y,
billingmethod=billing_method.y,
source="Renewal",
pricingsource=pricing_source,
siteid=site_id
)%>%
select(siteid,customerid,subscriptionid,planid,quantity,source,addressid,brand,productid,billingmethod,pricingsource)
write.csv(uscan_targets_20240625%>%
left_join(ANG_20240625,by=c("subscription_id"="pelcro_subscription_id"))%>%
mutate(subscriptionid=subscription_id,
customerid=pelcro_customer_id,
planid=plan_id,
quantity=plan_interval_count,
addressid=shipping_address_id,
brand=businessunitcode,
productid=product_id.y,
billingmethod=billing_method.y,
source="Renewal",
pricingsource=pricing_source,
siteid=site_id
)%>%
select(siteid,customerid,subscriptionid,planid,quantity,source,addressid,brand,productid,billingmethod,pricingsource),"cleaned_uscan_targets_20240625.csv")
library(tidyverse)
sample(c("W","L"),size=n,prob=c(p,1-p),replace=TRUE)
sim_globe<-function(p,n){
sample(c("W","L"),size=n,prob=c(p,1-p),replace=TRUE)
}
compute_posterior<-function(W,L,poss=c(0,0.25,0.5,0.75,1)){
ways<-sapply(poss,function(q)q^W*(1-q)^L)
post<-ways/sum(ways)
data.frame(post,ways,post=round(post,3))
}
compute_posterior("WWWW","LLLLLLLLLLL")
compute_posterior(4,11)
compute_posterior(4,11)%>%
ggplot(post.1)+geom_bar(stat=identity)
compute_posterior(4,11)
compute_posterior(4,11)%>%
summarise(n=n())
compute_posterior(4,11)%>%
ggplot(post.1)+geom_bar(stat=identity)
compute_posterior(4,11)%>%
ggplot(`post.1`)+geom_bar(stat=identity)
compute_posterior(4,11)
compute_posterior(4,11)%.%
ggplot(`post`)+geom_bar(stat=identity)
compute_posterior(4,11)%>%
ggplot(`post`)+geom_bar(stat=identity)
compute_posterior(4,11)
compute_posterior<-function(W,L,poss=c(0,0.25,0.5,0.75,1)){
ways<-sapply(poss,function(q)q^W*(1-q)^L)
post<-ways/sum(ways)
return(data.frame(post,ways,post=round(post,3)))
}
f<-compute_posterior(4,11)
f
f%>%
ggplot(aes(post))+geom_bar(stat="identity")
f%>%
ggplot(aes(post))
f%>%
ggplot(aes(post))
f
f<-compute_posterior(4,11,poss=seq(0,1,by=0.1))
f%>%
ggplot(aes(post))
f
f
post_samples<-sample(f$post)
post_samples<-sample(f$post,n=1000)
?sample()
post_samples<-sample(f$post,size=1000)
p_samples<-rbeta(1000,4+1,11+1)
?rbinom()
W_sim<-rbinom(1000,size=5,p_samples)
W_sim
W_sim
w_sim_df<-as.data.frame(w_sim_df)
w_sim_df<-as.data.frame(W_sim)
w_wim_df
w_sim_df
w_sim_df%>%
filter(W_sim>=3)
w_sim_df%>%
filter(W_sim>=3)%>%
summarise(n=n())
number_of_ways_to_produce_3<-w_sim_df%>%
filter(W_sim>=3)%>%
summarise(n=n())$n
number_of_ways_to_produce_3<-nrow(w_sim_df%>%
filter(W_sim>=3))
total_ways<-nrow(w_sim_df)
prob<-number_of_ways_to_produce_3/total_ways
install.packages(c("coda","mvtnorm","devtools","loo","dagitty","shape"))
devtools::install_github("rmcelreath/rethinking")
install.packages(c("coda", "mvtnorm", "devtools", "loo", "dagitty", "shape"))
library(tidyverse)
library(DBI)
library(RPostgres)
library("readr")
prod <- dbConnect(RPostgres::Postgres(),
host = 'crain-aspire-1.cdhessuxqdxg.us-east-1.redshift.amazonaws.com',
port = 5439,
user = 'aspireuser',
password = 'Aspirecrainredshift1',
dbname = 'prod',
sslmode='require')
mh_adv_data<-dbGetQuery(prod,statement=read_file("mh_query.sql"))
mh_adv_data%>%
filter(donortype=="I")
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)%>%
arrange(shiptocustomernumber)
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
filter(publicationcode=="MH")
mh_adv_data%>%
filter(donortype=="I")%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
group_by(shiptocustomernumber,ordernumber)%>%
filter(publicationcode=="MH")
mh_adv_data%>%
filter(donortype=="I")%>%
filter(orderdate>=as.Date("05/15/2023",format="%m/%d/%Y"))
mh_adv_data%>%
filter(donortype=="I")%>%
filter(orderdate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
group_by(shiptocustomernumber,ordernumber)%>%
filter(publicationcode=="MH")
mh_adv_data%>%
filter(donortype=="I")%>%
filter(orderdate>as.Date("05/15/2023",format="%m/%d/%Y"))%>%
group_by(shiptocustomernumber,ordernumber)%>%
filter(publicationcode=="MH")
mh_adv_data%>%
filter(donortype=="I")%>%
filter(orderdate>as.Date("05/15/2023",format="%m/%d/%Y"))%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
124.5*2
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n())
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,"Print + Digital",
ifelse(max_pub_level==2&n==1,"Print","Digital")))
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber,isautorenew,termlength)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_adv_data%>%
head(10)%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber,isautorenew,termlength)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_individual_cleaned<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber,isautorenew,termlength)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_individual_cleaned
mh_individual_cleaned%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned
autorenew_index<-mh_adv_data%>%
filter(donortype=="I")%>%
select(shiptocustomernumber,ordernumber,isautorenew)
autorenew_index<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(max_date=max(startissuedate))%>%
filter(startissuedate==max_date)%>%
select(shiptocustomernumber,ordernumber,isautorenew)%>%
distinct()
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
filter(isautorenew.x==isautorenew.y)
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
filter(isautorenew.x==isautorenew.y)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
filter(isautorenew.x==isautorenew.y)%>%
group_by(shiptocustomernumber,ordernumber)
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
filter(isautorenew.x==isautorenew.y)%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber,termlength)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
autorenew_index<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(max_date=max(startissuedate))%>%
filter(startissuedate==max_date)%>%
select(shiptocustomernumber,ordernumber,isautorenew)%>%
distinct()
autorenew_index
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
filter(isautorenew.x==isautorenew.y)%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
autorenew_index
autorenew_index%>%
mutate(isautorenew=ifelse(isautorenew=="N",0,1))
autorenew_index%>%
mutate(isautorenew=ifelse(isautorenew=="N",0,1))%>%
summarise(isautorenew=max(isautorenew))
autorenew_index<-autorenew_index%>%
mutate(isautorenew=ifelse(isautorenew=="N",0,1))%>%
summarise(isautorenew=max(isautorenew))
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
termlength=max(as.numeric(termlength)),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(n=n())%>%
filter(n>1)
mh_individual_cleaned%>%
filter(donortype=="I")
mh_individual_cleaned%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()
mh_data<-mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter(rate==189|rate==229)
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter((rate==189)|rate==229)
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()
filter((rate==189)|rate==229)
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter((rate==189)|rate==229)
mh_individual_cleaned<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
2))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
max_pub_level=max(pub_math),
termlength=max(as.numeric(termlength)),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_data<-mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter((rate==189)|rate==229)
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter((rate==189)|rate==229)%>%
mutate(product=ifelse(max_pub_level==3,"Print + Digital",
ifelse(max_pub_level==2,"Print","Digital")))
mh_adv_data
mh_adv_data%>%
filter(shiptocustomernumber==685207)
mh_adv_data%>%
filter(shiptocustomernumber==685207&ordernumber=='D3993261')
mh_adv_data%>%
filter(shiptocustomernumber==685207)
mh_adv_data%>%
filter(shiptocustomernumber==685207)%>%
order_by(firstissuesent)
mh_adv_data%>%
filter(shiptocustomernumber==685207)%>%
arrange(firstissuesent)
mh_adv_data%>%
filter(shiptocustomernumber==685207)%>%
arrange(startissuedate)
mh_individual_cleaned<-mh_adv_data%>%
filter(donortype=="I")%>%
group_by(shiptocustomernumber,ordernumber)%>%
mutate(pub_level=ifelse(publicationcode=="MHZ",1,
ifelse(publicationcode=="MH",2,3)))%>%
mutate(n=n_distinct(publicationcode))%>%
mutate(max_pub_level=max(pub_level),
pub_math=ifelse(max_pub_level==2&n==2,3,
ifelse(max_pub_level==2&n==1,2,1)),
did_renew=ifelse(!is.na(renewaltermnumber),1,0))%>%
ungroup()%>%
group_by(shiptocustomernumber,ordernumber)%>%
summarise(firstissuesent=min(firstissuesent),
termnumber=max(termnumber),
orderdate=min(orderdate),
max_pub_level=max(pub_math),
termlength=max(as.numeric(termlength)),
startissuedate=min(startissuedate),
expirationissuedate=min(expirationissuedate),
rate=sum(rate),
did_renew=max(did_renew),
renewalorderdate=min(renewalorderdate,na.rm=TRUE),
renewalstartdate=min(renewalstartdate,na.rm=TRUE),
renewaltermlength=max(renewaltermlength,na.rm=TRUE),
renewalrate=sum(renewalrate,na.rm=TRUE)
)
mh_data<-mh_individual_cleaned%>%
left_join(autorenew_index,by=c("shiptocustomernumber"="shiptocustomernumber","ordernumber"="ordernumber"))
mh_data
mh_data%>%
filter(expirationissuedate>=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
filter(orderdate<=as.Date("05/15/2023",format="%m/%d/%Y"))%>%
distinct()%>%
filter((rate==189)|rate==229)%>%
mutate(product=ifelse(max_pub_level==3,"Print + Digital",
ifelse(max_pub_level==2,"Print","Digital")))
